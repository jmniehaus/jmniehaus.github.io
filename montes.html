<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Monte Carlos</title>

<script src="site_libs/header-attrs-2.14/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/yeti.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/navigation-1.1/codefolding.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>



<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

.sourceCode .row {
  width: 100%;
}
.sourceCode {
  overflow-x: auto;
}
.code-folding-btn {
  margin-right: -30px;
}
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<link rel="stylesheet" href="styles.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">John M. Niehaus</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="./files/niehaus_cv_2022_online.pdf">CV</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Programming &amp; Derivations
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="irls.html">Iteratively Reweighted Least Squares for GLMs</a>
    </li>
    <li>
      <a href="mvnorm.html">Multivariate Normal Draws</a>
    </li>
    <li>
      <a href="montes.html">An In-depth Guide to Monte Carlos in R, with Examples</a>
    </li>
    <li class="dropdown-header">COMING SOON:</li>
    <li class="dropdown-header">Numerical Maximum Likelihood Estimation in R, with Examples</li>
    <li class="dropdown-header">Copulas and Copula Regression</li>
    <li class="dropdown-header">Bias of MLE for Gamma Rate Parameter</li>
    <li class="dropdown-header">Derivation of Negative Binomial Regression</li>
    <li class="dropdown-header">Spurious Regression Problem in Time Series</li>
    <li class="dropdown-header">Omitted Variables Bias in Probit Models</li>
    <li class="dropdown-header">Building this Website</li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="http://github.com/jmniehaus">
    <span class="fab fa-github"></span>
     
    Github
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">

<div class="btn-group pull-right float-right">
<button type="button" class="btn btn-default btn-xs btn-secondary btn-sm dropdown-toggle" data-toggle="dropdown" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu dropdown-menu-right" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>



<h1 class="title toc-ignore">Monte Carlo Analysis in R: An in Depth
Guide, with Examples</h1>
<h4 class="date">Updated: 14 May, 2022</h4>

</div>


<style>
.list-group-item.active, .list-group-item.active:focus, .list-group-item.active:hover {
    background-color: SlateGrey;
}
</style>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: { 
      equationNumbers: { 
            autoNumber: "AMS",
      } 
  }
});
</script>
<p><br />
</p>
<p>In this guide I first review the intuition of Monte Carlo methods,
and then discuss five steps to efficient, publication-quality Monte
Carlo analyses using R. Generally, these steps consist of:</p>
<ol style="list-style-type: decimal">
<li><a href="#serial-vs-parallel">Switching from serial to parallel
loops</a></li>
<li><a href="#seed-setting-and-parallelism">Ensuring reproducibility by
setting seeds properly for parallel tasks</a></li>
<li><a href="#thread-competition">Ensuring that other parallel tasks are
not competing for CPU resources</a></li>
<li><a href="#parameter-grids">Properly setting up simulation parameter
grids</a></li>
<li><a href="#using-functions-properly">Compartmentalizing code into
simulation and estimation functions</a></li>
</ol>
<p>First, I will walk through each of these five points with toy
examples to drive ideas home where applicable. Finally, I will take all
of this and put it together in some more serious applications.</p>
<p><strong>Note</strong> that this guide applies mostly to the case of
trivial parallelism, i.e., simulations that are independent of each
other. However, some concepts can be extended to dependent simulations,
particularly in MCMC algorithms that rely on full-conditionals. Where
this is the case, I note it in the Caveats subsection of a topic.</p>
<p><br />
</p>
<div id="brief-review-of-monte-carlo-methods" class="section level1">
<h1>Brief Review of Monte Carlo Methods</h1>
<hr />
<p>All of Monte Carlo analysis hinges on a Law of Large numbers. These
laws effectively state that the sample mean of a random variable
converges to its population mean, i.e., that the sample mean is a
consistent estimator. In the context of investigating the behavior of
estimators under particular conditions, these laws of large numbers
imply that if we simulate a large number of estimates, then the sample
mean of these estimates converges to the true mean of the estimator.
With that idea in mind, we can also compute a whole host of other
interesting quantities, such as the variance, the density function, or
the quantile function, <em>because all of these can be re-written as a
sample mean of a random variable.</em> <strong>Without any math, this is
the primary intuition of Monte Carlo analysis: many of the quantities
that we are interested in can be expressed as a sample mean of a random
variable, so we know they converge to the true value of the quantity of
interest due to a law of large numbers.</strong></p>
<p>For example <span class="math display">\[ \lim_{n\to\infty}
\frac{1}{n}\sum_{i=1}^n X_i = \mu_x \]</span> meaning that the sample
mean converges to the population mean as the sample size tends to
infinity. However, as the bold text above indicates, <em>a whole host of
other quantities converge to their true expected values</em>, for
example:</p>
<ul>
<li><p>The variance:<a href="#fn1" class="footnote-ref"
id="fnref1"><sup>1</sup></a> <span class="math display">\[\frac{1}{n}
\sum_{i=1}^n (X_i - \bar X)^2 \longrightarrow
\mathrm{var}(X)\]</span></p></li>
<li><p>The CDF: <span class="math display">\[\hat F(x) = \frac{1}{n}
\sum_{i=1}^n \underset{(-\infty, x]}{\mathbb{I}}(X_i) \longrightarrow
F_X(x)\]</span></p></li>
<li><p>The density function (using kernel <span
class="math inline">\(K\)</span> and bandwidth <span
class="math inline">\(h\)</span>):<a href="#fn2" class="footnote-ref"
id="fnref2"><sup>2</sup></a> <span class="math display">\[\hat f(x) =
\frac{1}{n} \sum_{i=1}^{n} \frac{1}{h} K\left(\frac{x - X_i}{h}\right)
\longrightarrow f_X(x)\]</span></p></li>
<li><p>The quantile function:<a href="#fn3" class="footnote-ref"
id="fnref3"><sup>3</sup></a> <span class="math display">\[\hat Q\{\hat
F(x)\} = \text{inf}\left\{x:\frac{1}{n}\sum_{i=1}^{n}\underset{(-\infty,
x]}{\mathbb{I}}(X_i) \geq \alpha)\right\}  \longrightarrow \text{inf}(y:
F(x) \geq \alpha)\]</span></p></li>
</ul>
<p>So effectively we can simulate random variables, compute some
function of those realizations, then take the mean of the resulting
quantity, and the WLLN tells us that we converge to the expected value
of that function.</p>
<details>
<summary>
<span style="color: #0888a8;">Show me the math</span>
</summary>
<p>To prove the WLLN, we will need a a few pieces of background
information, namely Markov’s Inequality (used only to prove
Chebyshev’s), Chebyshev’s inequality, and the definition of convergence
in probability (note that all of this information can also be found in
most math-stat textbooks, or on Wikipedia).</p>
<ul>
<li><p><strong>Markov’s Inequality:</strong> Let <span
class="math inline">\(X\)</span> be a random variable with support over
the non-negative real line, i.e., <span class="math inline">\(\Pr(X \geq
0) = 1\)</span>. Then for every number <span class="math inline">\(c
&gt; 0\)</span>, <span class="math inline">\(\,\,\Pr(X \geq c) \leq
\frac{\mathbb{E}(X)}{c}\)</span>.</p>
<div style="margin-top:-22px;">
<details>
<summary>
<span style="color: #0888a8;">Proof</span>
</summary>
Assuming continuous <span class="math inline">\(X\)</span> with pdf
<span class="math inline">\(f\)</span>: <span
class="math display">\[\begin{align*}
\mathbb{E}(X) &amp;= \int_0^\infty x f(x) \,dx \\
      &amp;= \int_0^c x f(x) \,dx + \int_c^\infty x f(x) \,dx \\
      &amp;\geq \int_0^c x f(x) \,dx + \int_c^\infty c f(x) \,dx \\
      &amp;= \int_0^c x f(x) \,dx + c \int_c^\infty f(x) \,dx \\
      &amp;=  c \Pr(X \geq c) + \int_0^c x f(x) \,dx\\
      &amp;\geq c\Pr(X \geq c) \\[1em]
      \implies \Pr(X \geq c) &amp;\leq \frac{\mathbb{E}(X)}{c}
\end{align*}\]</span>
</details>
</div></li>
</ul>
<p>
</p>
<ul>
<li><p><strong>Chebyshev’s Inequality:</strong> Let <span
class="math inline">\(X\)</span> be a random variable with finite first
and second moments, <span class="math inline">\(\mu_X &lt;
\infty\)</span> and <span class="math inline">\(\sigma^2_X &lt;
\infty\)</span> respectively. Then for all numbers <span
class="math inline">\(c &gt; 0\)</span>, <span
class="math inline">\(\,\, \Pr(|X - \mu_X| \geq c) \leq
\frac{\sigma^2_X}{c^2}\)</span></p>
<div style="margin-top:-24px;">
<details>
<summary>
<span style="color: #0888a8;">Proof</span>
</summary>
<p>Let <span class="math inline">\(Y = (X - \mu_X)^2\)</span> and <span
class="math inline">\(c^2 = k\)</span>, then:</p>
<ul>
<li><p><span class="math inline">\(\Pr(|X - \mu_X| \geq c) =
\Pr\left[(X-\mu_X)^2 \geq c^2\right] = \Pr(Y \geq k)\)</span>,
and</p></li>
<li><p><span class="math inline">\(\mathbb{E}(Y) = \mathbb{E}\left[(X -
\mu_X)^2\right] = \sigma^2_X\)</span> by definition.</p></li>
<li><p>Then by Markov’s Inequality, we have: <span
class="math display">\[\Pr(|X - \mu_X| \geq c) = \Pr(Y \geq k) \leq
\frac{\mathbb{E}(Y)}{k} = \frac{\sigma^2_X}{c^2}\]</span></p></li>
</ul>
</details>
</div></li>
</ul>
<p>
</p>
<ul>
<li><strong>Convergence in Probability (to a constant):</strong> For a
sequence of independent random variables <span class="math inline">\(X_n
= X_1, X_2, ...\)</span> with the same mean <span
class="math inline">\(\mu_X &lt; \infty\)</span> and same variance <span
class="math inline">\(\sigma^2_X &lt; \infty\)</span>, and for constants
<span class="math inline">\(c\)</span> and <span
class="math inline">\(\varepsilon\)</span>: if <span
class="math inline">\(\lim_{n\to\infty} \Pr(|X_n - c|&gt;\varepsilon) =
0 \hspace{1em} \forall \hspace{1em} \varepsilon &gt; 0\)</span> then
<span class="math inline">\(\,\,X_n \overset{p}{\longrightarrow}
c\)</span>.</li>
</ul>
<p>
</p>
<p>The WLLN then states that</p>
<p><span class="math display">\[\begin{equation*}\frac{1}{n}
\sum_{i=1}^{n} X_i \overset{p}{\longrightarrow} \mu_X
\end{equation*}\]</span></p>
<p>which can be generalized to functions <span
class="math inline">\(g\)</span> of <span
class="math inline">\(X\)</span>:</p>
<p><span class="math display">\[\begin{equation*} \lim_{n\to\infty}
\frac{1}{n}\sum_{i=1}^n g(X_i) \overset{p}\longrightarrow
\mathbb{E}[g(X_n)] = \int_{X} g(x) \,\, \mathrm dF_X(x)
\end{equation*}\]</span></p>
<p>for random variables <span class="math inline">\(X_i
\overset{iid}{\sim} f_X, \,\, i\in 1,2,...,n\)</span>, and (almost) any
function <span class="math inline">\(g\)</span>. This effectively says
that the sample average of nearly any function of the data converges in
probability to the true expected value.</p>
<p>This is proven using Chebyshevs inquality. First, by the linearity of
expectation, we know that <span class="math inline">\(\mathbb{E}(\bar X)
= \mu_X\)</span> and <span class="math inline">\(\mathrm{var}(\bar X) =
\sigma^2_X/n\)</span>. Then,</p>
<span class="math display">\[\begin{align*}
\Pr(|\bar X - \mu_X| \geq \varepsilon) &amp;\leq
\frac{\sigma^2_X}{n\varepsilon^2} \\[1ex]
\implies \lim_{n\to\infty} \Pr(|\bar X - \mu_X| \geq \varepsilon)
&amp;\leq \lim_{n\to\infty} \frac{\sigma^2_X}{n\varepsilon^2} \\[1em]
&amp;= 0
\end{align*}\]</span> where this last equality follows because <span
class="math inline">\(0 \leq \lim_{n\to\infty} \Pr(|\bar X - \mu_X| \geq
\varepsilon) \leq 0\)</span> by the definition of a density function for
the lower bound, which concludes the proof.
</details>
<p><br />
</p>
</div>
<div id="simulations-serial-vs-parallel" class="section level1">
<h1>Simulations: Serial vs Parallel</h1>
<hr />
<p>As implied by the review of Monte Carlo analysis, simulations will
involve a great number of iterations in order to obtain a sufficiently
large sample to be averaged over, such that the error in our
approxmiation is small. Unfortunately, R is single-threaded by default,
meaning everything that you do in R is executed on a single CPU on your
computer. So even if you have a quad-core processor that has 8 CPUs due
to <a
href="https://www.cgdirector.com/cpu-cores-vs-logical-processors-threads/">multi-threading</a>,
only one of these 8 potential processes is being used by R by default.
However, most Monte Carlo analyses would theoretically benefit from
being able to compute quantities simultaneously: if we want to compute a
bunch of sample means that are independent of eachother, then why not
compute 8 means at a time, rather than one? Naturally then, implementing
Monte Carlo analyses in parallel will be the first step to obtaining
results efficiently. There are exceptions to this rule (e.g., reserving
computing resources for other tasks, parallel overhead making things
slower), but if the reason you are not using parallel processing is
simply because you do not know how, then I’ll walk you through a few
approaches here.</p>
<p><strong>For going parallel in R, there are essentially two
options</strong>:</p>
<ol style="list-style-type: decimal">
<li><p>Using <code>foreach</code> loops, which are similar, yet distinct
from the typical <code>for</code> loop</p></li>
<li><p>Using the parallelized <code>apply</code> family of functions,
e.g., <code>parLapply</code>, <code>parApply</code>, and
friends.</p></li>
</ol>
<p>I’ve used both approaches extensively (in the past I only used the
<code>apply</code> approach), and strongly prefer the
<code>foreach</code> approach at this point for a few reasons:</p>
<ol style="list-style-type: lower-alpha">
<li><p>It tends to be more intuitive as its similar to <code>for</code>
loops in appearance</p></li>
<li><p>Tends to be easier to debug (in my opinion)</p></li>
<li><p>Doesn’t require nested function calls for complicated
simulations</p></li>
<li><p>Permits nested parallel looping</p></li>
<li><p>Can be more memory efficient</p></li>
</ol>
<p>For these reasons, I won’t be covering the <code>apply</code> family
of functions here. I may eventually extend the principles and examples
below to the <code>apply</code> family, but for now we’ll focus on
<code>foreach</code>.</p>
<p><br />
</p>
<div id="differences-between-foreach-and-for" class="section level3">
<h3>Differences between <code>foreach</code> and <code>for</code></h3>
<hr />
<p>Before diving in, note that this is only a quick introduction to
<code>foreach</code>. We’ll go over how it differs from <code>for</code>
loops and some of the key arguments, but if you want to learn more, I
highly recommend taking a look at its <a
href="https://cran.r-project.org/web/packages/foreach/vignettes/foreach.html">vignette</a>.
If you’re more of a DataCamp or otherwise type of person, there is an
entire course on <a
href="https://www.datacamp.com/courses/parallel-programming-in-r">parallel
processing in R</a> available through them (I am not affiliated with
DataCamp, nor do I receive anything from them for linking this). There
are also more in-depth resources on parallel processing in R available
<a
href="https://nceas.github.io/oss-lessons/parallel-computing-in-r/parallel-computing-in-r.html">here</a>,
<a
href="https://dept.stat.lsa.umich.edu/~jerrick/courses/stat701/notes/parallel.html">here</a>,
and <a
href="https://bookdown.org/rdpeng/rprogdatascience/parallel-computation.html">here</a>,
although Googling around will definitely yield droves of additional
content.</p>
<p>To see how <code>foreach</code> works, its useful to compare and
contrast it with a typical <code>for</code> loop. Suppose we just wanted
to add 1 to each element in a vector, and for some reason we did this
using a for loop in R (rather than leveraging vectorization). We might
write the following:</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="do">### for loop</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>vec <span class="ot">=</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">5</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>out_for <span class="ot">=</span> <span class="fu">vector</span>()</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">seq_along</span>(vec)) </span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  out_for[i] <span class="ot">=</span> vec[i] <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(out_for)</span></code></pre></div>
<pre class="bg-success"><code>## [1] 2 3 4 5 6</code></pre>
<p><br />
</p>
<p>Then, using the <code>foreach</code> package, an equivalent loop
could be written like so:</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="do">### foreach </span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(foreach)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>vec <span class="ot">=</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">5</span>)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>out_foreach <span class="ot">=</span> </span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">foreach</span>(<span class="at">i =</span> <span class="fu">seq_along</span>(vec),</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>          <span class="at">.combine =</span> <span class="st">&quot;c&quot;</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>          ) <span class="sc">%do%</span> {</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(vec[i] <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(out_foreach)</span></code></pre></div>
<pre class="bg-success"><code>## [1] 2 3 4 5 6</code></pre>
<p><br />
</p>
<p>Despite having a somewhat similar appearance to the <code>for</code>
loop, <strong><code>foreach</code> loops are different because they are
functions, while <code>for</code> loops are not.</strong></p>
<p>In fact, <code>foreach</code> loops are composed of at least two
functions, and one <code>expression</code>-class object:</p>
<ol style="list-style-type: decimal">
<li><p>The first function is a bit obvious, its a call to
<code>foreach(...)</code>.</p></li>
<li><p>The second function is actually the <a
href="https://adv-r.hadley.nz/functions.html#function-forms">infix
function</a>, <code>%do%</code>, or as we’ll see later,
<code>%dopar%</code> or <code>%dorng%</code>.</p></li>
<li><p>The <code>expression</code>-class object is the loop code inside
the curly braces <code>{...}</code>, and can be thought of as a string
for our purposes.</p></li>
</ol>
<p>We’ll start with (2), the <code>%do%</code> infix function. Notice
its similar appearance to the matrix multiplication operator,
<code>%*%</code>. Just as the <code>%*%</code> matrix multiplication
operator takes its arguments on either side, so does the
<code>%do%</code> or <code>%dopar%</code> operator (or any other
arbitrary infix function). Thus, we can conclude that <strong>the call
to <code>foreach(...)</code> on the left-hand side, and the set of loop
instructions on the right-hand side between the curly braces
<code>{...}</code> are both arguments to the <code>%do%</code>
function</strong>.</p>
<p>Moving to the call to <code>foreach(...)</code> on the left-hand side
of <code>%do%</code>, we’ve just learned that this function (or rather,
the <em>return value</em> of this function) is an argument to the
<code>%do%</code> operator. Its reasonable to ask what the
<code>foreach()</code> function returns, then, as its return value is an
input to another function. Lets take a look:</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>fe_call <span class="ot">=</span> <span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(fe_call)</span></code></pre></div>
<pre class="bg-success"><code>## List of 11
##  $ args         : language (1:3)()
##  $ argnames     : chr &quot;i&quot;
##  $ evalenv      :&lt;environment: R_GlobalEnv&gt; 
##  $ specified    : chr(0) 
##  $ combineInfo  :List of 7
##   ..$ fun          :function (a, ...)  
##   ..$ in.order     : logi TRUE
##   ..$ has.init     : logi TRUE
##   ..$ init         : language list()
##   ..$ final        : NULL
##   ..$ multi.combine: logi TRUE
##   ..$ max.combine  : num 100
##  $ errorHandling: chr &quot;stop&quot;
##  $ packages     : NULL
##  $ export       : NULL
##  $ noexport     : NULL
##  $ options      : list()
##  $ verbose      : logi FALSE
##  - attr(*, &quot;class&quot;)= chr &quot;foreach&quot;</code></pre>
<p><br />
</p>
<p>So <code>foreach()</code> returns a list, with a whole bunch of named
elements. We’ll touch on some of these later on, but for now you can
roughly think of <code>foreach()</code> as being the same as the serial
case when we call <code>for(i in something)</code>: it is creating an
object to be iterated over. In reality things are a bit more complicated
than that, but the details are not too important here. It is enough to
know that <code>foreach()</code> is a function, and it returns an object
that is in some way useful for iterating and executing a loop in
parallel. The results of calling this <code>foreach(...)</code> function
are then used as the inputs on the left-hand side of
<code>%do%</code>.</p>
<p>Finally, on the right-hand side of <code>%do%</code> we have an
<code>expression</code>-class object, which can just be thought of as
our loop code. But, because these instructions will be executed on
several CPUs simultaneously, we need to send them off to each core
first, and <em>then</em> execute the instructions and return their
collective results. This is why <code>foreach</code> loops are actually
function calls, because they have to send off a set of instructions in a
unified way to several child processes for execution, keep track of that
execution, combine the results, and return them in a sensible way. In
contrast, <code>for</code> loops are running on a single process, so the
instructions can just be executed on that process in real-time.</p>
<p>If any of this is confusing, <strong>the main takeaway is that
<code>foreach</code> loops are actually functions. Since functions have
a <code>return</code> value, we stored the results in the
<code>out_foreach</code> object, and gave the <code>foreach</code> loop
an explicit <code>return()</code> call at the end. This is because we
send off our code to several R processes, and each process needs to know
what to be working on, and what to return.</strong></p>
<p><br />
</p>
</div>
<div id="making-foreach-run-in-parallel" class="section level3">
<h3>Making <code>foreach</code> Run in Parallel</h3>
<hr />
<p>Now that you have the basics of how <code>foreach</code> and
<code>for</code> differ, we can move on to making things work in
parallel. The above toy example is in fact running serially in both the
<code>foreach</code> and <code>for</code> loops. However, to make the
<code>foreach</code> loop run in parallel requires trivial alterations
to the code above:</p>
<ol style="list-style-type: decimal">
<li><p>Tell R how many cores to use. This should be one less than the
max if using R-studio, so that R-studio still has resources to
run.</p></li>
<li><p>Create a cluster and register it as a parallel back-end using the
<code>doParallel</code> package.</p></li>
<li><p>Change <code>%do%</code> to <code>%dopar%</code> (though later
we’ll see that a better alternative is actually
<code>%dorng%</code>).</p></li>
<li><p>Shut down the parallel backend (<strong>this is extremely
important for PC longevity</strong>).</p></li>
</ol>
<p>Using the same example from the previous section of adding 1 to each
element of a vector, each of these steps for going parallel are
implemented in the code below.</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="do">### 0. Need the doParallel package for this</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(doParallel)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="do">### 1. Tell number of cores to use (one less than max, if using Rstudio)</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>ncores <span class="ot">=</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>() <span class="sc">-</span> <span class="dv">1</span> </span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="do">### 2. Create cluster, and register parallel backend</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>cl <span class="ot">=</span> <span class="fu">makeCluster</span>(ncores)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="fu">registerDoParallel</span>(cl)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="do">### 3. Change `%do%` to `%dopar%` </span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>out_foreach <span class="ot">=</span> <span class="fu">foreach</span>(<span class="at">i =</span> <span class="fu">seq_along</span>(vec),</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>                      <span class="at">.combine =</span> <span class="st">&quot;c&quot;</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>                      ) <span class="sc">%dopar%</span> {</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(vec[i] <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a><span class="do">### 4.shut down the cluster DONT FORGET THIS</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a><span class="fu">stopCluster</span>(cl)</span></code></pre></div>
<p><br />
</p>
</div>
<div id="important-foreach-parameters" class="section level3">
<h3>Important <code>foreach</code> Parameters</h3>
<hr />
<p>Although this is certainly not a guide on the <code>foreach</code>
package (see the <a href="#differences-between-foreach-and-for">previous
links</a> for more detail on the package), there are a few parameters
worth discussing here.</p>
<ul>
<li><p><code>.combine</code> — This is a function that tells
<code>foreach</code> how to combine the results, e.g.,
<code>list</code>, <code>c</code> (for concatenate), <code>rbind</code>,
etc. (or some custom function). I typically leave this
<code>NULL</code>, which returns the results in a list. I do this
because combining results takes time, and I don’t necessarily want to
take that time immediately after simulations complete.</p></li>
<li><p><code>.inorder</code> — A logical value that indicates whether
the results should be combined in the order they were submitted to the
workers. I always set this to <code>FALSE</code> because I don’t care
about the ordering, I just want my results as fast as possible.
<strong>NOTE: the default is <code>TRUE</code>, meaning you combine in
order by default.</strong></p></li>
<li><p><code>.multicombine</code> — Logical value indicating whether the
<code>.combine</code> function can take more than 2 arguments. For most
conventional functions, e.g., <code>list</code>, <code>cbind</code>,
<code>rbind</code>, <code>c</code>, this should be <code>TRUE</code>.
This matters because if the <code>.combine</code> function has more than
2 arguments, then the <code>do.call</code> function can be used to call
it on a list, which will tend to be faster than running a loop to
combine results iteratively. Essentially, be sure to set this to
<code>TRUE</code> if using the conventional functions listed
here.</p></li>
<li><p><code>.maxcombine</code> — This tells <code>foreach</code> how
many sets of results to combine at one time. The default is 100 results
at a time, which is going to be painfully slow for any modest set of
Monte Carlo results. I tend to set this to the total number of expected
results, meaning that <code>foreach</code> should combine them all at
once. With modern hardware this shouldn’t be too problematic, but I
stand to be corrected.</p></li>
<li><p><code>.errorhandling</code> — Tells how to handle errors on each
thread. When I’m debugging, I typically set this to <code>"stop"</code>,
so that errors kill the simulations. However, once I know there are no
issues, I set this to <code>"pass"</code> so that errors are ignored,
but their message is kept in the results. For complicated problems this
is useful because there are instances where an algorithm may not
converge due to random chance in the data generating process. But, we
don’t want to kill all simulations when that happens, we want to just
keep going but know that for that particular iteration the algorithm did
not converge.</p></li>
<li><p><code>.packages</code> — This tells <code>foreach</code> what
packages to export to each parallel process. Remember,
<code>foreach</code> spins up a separate instance of R on each core, so
we have to tell these cores what packages to load. We do so using the
<code>.packages</code> parameter.</p></li>
<li><p><code>.export</code> — This tells <code>foreach</code> which
objects from the global environment to export to each process. Again,
because separate instances of R are created, we need to ensure that each
process has access to all the relevant objects. <strong>Note:</strong>
This is less relevant when using a <code>FORK</code> cluster, as
detailed in the next section.</p></li>
</ul>
<p><br />
</p>
</div>
<div id="fork-or-psock" class="section level3">
<h3><code>FORK</code> or <code>PSOCK</code>?</h3>
<hr />
<p>When spinning up a parallel cluster, e.g., using
<code>makeCluster(cl)</code> as we did <a
href="#making-foreach-run-in-parallel">previously</a>, there is a
<code>type</code> parameter that controls the type of cluster that we
create, which is one of either <code>"FORK"</code> or
<code>"PSOCK"</code>. The default is <code>"PSOCK"</code>, but this can
be set, e.g. by calling
<code>makeCluster(your_cluster_object, type = "FORK")</code>.</p>
<p>The details on each cluster type are as follows:</p>
<ul>
<li><p><code>"FORK"</code> — This type of cluster duplicates the master
process on each child process, but allows them all to access the same
shared global environment from the master process. Think of the master
process as the process that you are interacting with in R where you type
your code. So, multiple R processes are spawned on your cores, but they
all access the same single global environment. This minimizes parallel
overhead communication between the processes. <strong>NOTE:</strong>
This type of cluster is only available on UNIX-alike machines (i.e.,
GNU-Linux, Mac), so <span style="color: red;"><strong>Windows users
cannot use this cluster type</strong></span>.</p></li>
<li><p><code>"PSOCK"</code> — This type of cluster does not have a
shared environment, new global environments are created for each of the
child processes. So, we have to tell the master process which objects to
export to its children using the <code>.export</code> option as
mentioned in the previous section, because entirely new (and empty)
environments are created for each child process.</p></li>
</ul>
<p>Because of the copying and ensuing communication required for
<code>"PSOCK"</code> clusters, some estimates put <code>"FORKS"</code>
as being <a
href="https://www.r-bloggers.com/2019/06/parallel-r-socket-or-fork/">roughly
40% faster than socket clusters</a>. Again though, if you’re using
Windows, you won’t be able to leverage this forking speed bonus.</p>
<p>Here’s a useful bit of code that will determine the cluster type
based on what operating system you’re using. I use a rendition of this
code for every set of Monte Carlos that I do, as I’d like to have a FORK
cluster whenever possible, and I don’t want to have to change code
whenever I move to a computer with a different OS.</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="do">### Dynamically decide cluster type based on OS type</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>ncpus <span class="ot">=</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>() <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>type <span class="ot">=</span> <span class="cf">if</span>(.Platform<span class="sc">$</span>OS.type <span class="sc">==</span> <span class="st">&#39;unix&#39;</span>) </span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>          <span class="st">&#39;FORK&#39;</span> </span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>       <span class="cf">else</span> </span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>          <span class="st">&#39;PSOCK&#39;</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>cl <span class="ot">=</span> <span class="fu">makeCluster</span>(ncpus, <span class="at">type =</span> type)</span></code></pre></div>
<p>As the <a
href="https://stat.ethz.ch/R-manual/R-devel/library/base/html/Platform.html">help
files</a> indicate, <code>.Platform$OS.type</code> will return
<code>"unix"</code> <em>for both Linux and Mac</em> (as Mac is
unix-like).</p>
<p>
</p>
<div>
<details>
<summary>
<span style="color: #0888a8;">What if I’m on Windows and I want to
FORK…</span>
</summary>
<p>If you would like to be able to fork but are on Windows, then <a
href="https://opensource.com/article/18/5/dual-boot-linux">dual-booting</a>
a Linux OS alongside your Windows installation is a free way to do so
while keeping your Windows installation intact. Its also a great way to
start learning about the Linux system, as this is often the system of
choice in many industrial data science positions. The purpose of this
guide is not to give instruction on how to do this, but a good starting
Linux distribution is <a
href="https://linuxmint.com/edition.php?id=292">Linux Mint Cinnamon
Edition</a>, which is built on top of the popular Debian-based <a
href="https://ubuntu.com/">Ubuntu</a>. If this interests you, I suggest
reading up on dual-booting Windows with Linux, and starting with either
of the two distributions listed here. After some more experience with
Linux, the Arch-based <a
href="https://manjaro.org/downloads/official/kde/">Manjaro KDE</a> is
great, and is in fact what I use daily. Finally note that most popular
Linux distributions are like any other operating system in that they
have a graphical user interface and can be completely navigated using
point-and-click actions, in case you mistakenly think that using Linux
implies knowing a bunch about computer science.</p>
<p>An alternative to dual-booting is to utilize <a
href="https://docs.microsoft.com/en-us/windows/wsl/about">the Windows
subsystem for Linux</a>, although this approach is command line
interface (CLI) only, meaning there is no point-and-click functionality.
So unless you’re already familiar with Linux, this may be too much of a
hassle.</p>
</details>
</div>
<p><br />
</p>
</div>
</div>
<div id="seed-setting-and-parallelism" class="section level1">
<h1>Seed Setting and Parallelism</h1>
<hr />
<p>If you’re running simulations, you probably want to be able to
reproduce them, either on your own machine at a later date, or on
another machine. However, if you’ve now implemented parallel processing
as suggested using <code>%dopar%</code>, <strong>setting your seed is no
longer as straightforward as in the serial case</strong>.</p>
<p>For example, lets simulate some random variables using both a serial
loop and parallel loop, and set the seed before hand. We’d expect that
the results are the same, but this turns out to be false. First,
serially:</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="do">### Serially</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>serial_1 <span class="ot">=</span> serial_2 <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>) </span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  serial_1[i] <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="dv">1</span>)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>) </span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  serial_2[i] <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="dv">1</span>)</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(serial_1, serial_2)</span></code></pre></div>
<pre class="bg-success"><code>## [1] TRUE</code></pre>
<p>which produces two vectors of the exact same numbers, as we’d expect
given the above code.</p>
<p>However, when we implement the “equivalent” in parallel (notice how
the infix property becomes more apparent in the code below, too):</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="do">### Parallel</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>ncores <span class="ot">=</span> <span class="dv">3</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>cl <span class="ot">=</span> <span class="fu">makeCluster</span>(ncores)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="fu">registerDoParallel</span>(cl)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>parallel_1 <span class="ot">=</span> </span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">.combine =</span> c) <span class="sc">%dopar%</span> { <span class="fu">rnorm</span>(<span class="dv">1</span>) }</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>parallel_2 <span class="ot">=</span> </span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">.combine =</span> c) <span class="sc">%dopar%</span> { <span class="fu">rnorm</span>(<span class="dv">1</span>) }</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="fu">stopCluster</span>(cl)</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(parallel_1, parallel_2)</span></code></pre></div>
<pre class="bg-danger"><code>## [1] FALSE</code></pre>
<p>we end up with results which are not the same, despite setting the
seed as one would typically do in the serial case. The details of why
this is happening are technical and mostly unimportant; what is
important is that there are some simple solutions.</p>
<p><br />
</p>
<div id="option-1-dorng" class="section level3">
<h3>Option 1: <code>doRNG</code></h3>
<hr />
<p>The simplest solution is to use the <a
href="https://cran.r-project.org/web/packages/doRNG/vignettes/doRNG.pdf"><code>doRNG</code></a>
package. There are two ways to use the package to reproduce simulation
results.</p>
<ol style="list-style-type: decimal">
<li><strong><code>doRNG</code> Method 1</strong>: Set your seed as
usual, and replace <code>%dopar%</code> with <code>%dorng%</code>:</li>
</ol>
<div class="sourceCode" id="cb13"><pre
class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="do">### set.seed and  %dorng%</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(doRNG)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>ncores <span class="ot">=</span> <span class="dv">3</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>cl <span class="ot">=</span> <span class="fu">makeCluster</span>(ncores)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="fu">registerDoParallel</span>(cl)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>parallel_1 <span class="ot">=</span> </span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">.combine =</span> c) <span class="sc">%dorng%</span> { <span class="fu">rnorm</span>(<span class="dv">1</span>) }</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>parallel_2 <span class="ot">=</span> </span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">.combine =</span> c) <span class="sc">%dorng%</span> { <span class="fu">rnorm</span>(<span class="dv">1</span>) }</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="fu">stopCluster</span>(cl)</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(parallel_1, parallel_2)</span></code></pre></div>
<pre class="bg-success"><code>## [1] TRUE</code></pre>
<p><br />
2. <strong><code>doRNG</code> Method 2</strong>: Set your seed using
<code>registerDoRNG()</code> instead, then use <code>%dopar%</code> as
usual:</p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="do">### doRNG backend, %dopar%</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>ncores <span class="ot">=</span> <span class="dv">3</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>cl <span class="ot">=</span> <span class="fu">makeCluster</span>(ncores)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="fu">registerDoParallel</span>(cl)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="fu">registerDoRNG</span>(<span class="dv">123</span>)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>parallel_1 <span class="ot">=</span> </span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">.combine =</span> c) <span class="sc">%dopar%</span> { <span class="fu">rnorm</span>(<span class="dv">1</span>) }</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="fu">registerDoRNG</span>(<span class="dv">123</span>)</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>parallel_2 <span class="ot">=</span> </span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">.combine =</span> c) <span class="sc">%dopar%</span> { <span class="fu">rnorm</span>(<span class="dv">1</span>) }</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="fu">stopCluster</span>(cl)</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(parallel_1, parallel_2)</span></code></pre></div>
<pre class="bg-success"><code>## [1] TRUE</code></pre>
<p>Both approaches result in reproducible parallel loops.</p>
<p><br />
</p>
</div>
<div id="option-2-iteration-level-seeds" class="section level3">
<h3>Option 2: Iteration-level Seeds</h3>
<hr />
<p>A bit of a hacky alternative to <code>doRNG</code> is to simply set
the seed for each iteration. Remember from earlier that the instructions
set on the right-hand side of <code>%dopar%</code> are passed to each
core. Well, if every iteration passed to a core has a unique seed, then
any time we run the loops, the same results will obtain. To do this
we</p>
<ol style="list-style-type: decimal">
<li><p>Set an “outer” seed in the traditional way, i.e., using
<code>set.seed()</code> outside the <code>foreach</code> block.</p></li>
<li><p><code>sample()</code> “inner” seeds to be used in each iteration.
The number of inner seeds is equal to the number of
simulations/iterations (i.e., the max of your iteration index). Note
that this sampling will always produce the same inner seeds, because
we’ve set our outer seed in step (1).</p></li>
<li><p>Set the seed within your simulation code using
<code>set.seed()</code>, but using an indexed inner seed, where the
index is the iteration number.</p></li>
</ol>
<p>To make this more clear:</p>
<div class="sourceCode" id="cb17"><pre
class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>ncores <span class="ot">=</span> <span class="dv">3</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>nsims <span class="ot">=</span> <span class="dv">10</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>cl <span class="ot">=</span> <span class="fu">makeCluster</span>(ncores)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="fu">registerDoParallel</span>(cl)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)                 <span class="co"># Set seed in the usual way</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>inner_seeds <span class="ot">=</span> <span class="fu">sample</span>(         <span class="co"># Sample nsims-many inner seeds</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> <span class="dv">999999</span>, </span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">size =</span> nsims</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>parallel_1 <span class="ot">=</span> </span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span>nsims, </span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>          <span class="at">.combine =</span> c</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>          ) <span class="sc">%dopar%</span> {</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set.seed</span>(inner_seeds[i])  <span class="co"># Set seed for each iteration, using indexed seed</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rnorm</span>(<span class="dv">1</span>) </span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>parallel_2 <span class="ot">=</span> </span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span>nsims, </span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>          <span class="at">.combine =</span> c</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>          ) <span class="sc">%dopar%</span> {</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set.seed</span>(inner_seeds[i])</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rnorm</span>(<span class="dv">1</span>) </span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a><span class="fu">stopCluster</span>(cl)</span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(<span class="fu">unique</span>(inner_seeds)) <span class="sc">==</span> nsims</span></code></pre></div>
<pre class="bg-success"><code>## [1] TRUE</code></pre>
<div class="sourceCode" id="cb19"><pre
class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(parallel_1, parallel_2)</span></code></pre></div>
<pre class="bg-success"><code>## [1] TRUE</code></pre>
<p>As the code <code>length(unique(inner_seeds)) == nsims</code> tells
us, this isn’t setting the same exact seed on all cores. We made a
vector of distinct seeds, <code>inner_seeds</code>, and each simulation
uses one of these distinct seeds before executing its instructions. You
can think of this as setting a different seed across a bunch of
different R sessions, and then combining the results; however, the
universe of inner seeds to be used on each of these sessions remains the
same, and therefore so do the results across runs.</p>
<p>Now this is of course a bit hacky, and is clearly more complex than
using <code>doRNG</code>, but <strong>this approach does have practical
utility</strong>. Namely, if you ever need nested parallel loops (using
the <code>%:%</code> nesting operator detailed in the <a
href="https://cran.r-project.org/web/packages/foreach/vignettes/nested.html"><code>foreach</code>
documentation</a>), then unfortunately the <code>%dorng%</code> backend
is not supported. In other words, if you’d like nested, parallel loops,
you will not be able to use <code>doRNG</code> to ensure
reproducibility. In this case, the only way I have found to successfully
reproduce simulations is the above, iteration-level seed-setting
approach.</p>
<p><br />
</p>
</div>
</div>
<div id="thread-competition" class="section level1">
<h1>Thread Competition</h1>
<hr />
<p>Now we are running loops in parallel, and our pseudo-random numbers
are reproducible as we would want. However, there is a potential lurking
issue that will completely tank any simulations structured as we have
here: other multi-threaded/parallel tasks competing for CPU resources.
In other words, if R is trying to execute simulations in parallel while
also trying to execute some other task in parallel simultaneously, often
times your R-session will hang and eventually crash.</p>
<p><br />
</p>
<div id="blaslapack-induced-deadlock" class="section level3">
<h3>BLAS/LAPACK-Induced Deadlock</h3>
<hr />
<p>So why would anyone be doing multiple forms of parallel processing
simultaneously? The most common reason for this is when you are using
optimized BLAS/LAPACK libraries while executing linear algebra-heavy
simulations. This includes libraries like <a
href="https://www.openblas.net/">Open BLAS</a>, <a
href="https://www.intel.com/content/www/us/en/develop/documentation/get-started-with-mkl-for-dpcpp/top.html">Intel’s
MKL</a>, <a
href="https://developer.amd.com/amd-aocl/amd-math-library-libm/">AMD’s
Math Library</a>, <a
href="https://developer.apple.com/documentation/accelerate">Apple’s
Accelerate</a> or <a href="http://math-atlas.sourceforge.net/">ATLAS
BLAS</a>. In addition to having superior algorithms that are optimized
for your specific hardware, these libraries often times have
multi-threaded matrix operations; i.e., they do common matrix operations
in parallel, such as matrix multiplication, inversion, etc.<a
href="#fn4" class="footnote-ref" id="fnref4"><sup>4</sup></a> Thus, if
you are using these libraries and forget to disable their inherent
multi-threading, they will compete with <code>foreach</code> when
accessing your CPUs, which will ultimately hang your system. For
example, if your computer has 8 threads, and you tell R to give
<code>foreach</code> 7 of them, but MKL reserves 4 of them for matrix
operations, suddenly you’re trying to access <span
class="math inline">\(7 \times 4 = 28\)</span> threads when you only
have 8 (each of the 7 child processes will be linked to MKL, which
reserves 4 threads). The only option is to use the same thread for
multiple tasks simultaneously, but this isn’t possible so the computer
hangs. This is known as <a
href="https://en.wikipedia.org/wiki/Deadlock">deadlock</a> in
multi-threaded computing, with a particularly egregious case caused by
<a href="https://en.wikipedia.org/wiki/Fork_bomb">FORK bombs</a>.</p>
<p>To check if your PC is running multi-threaded matrix operations, use
the <a
href="https://cran.r-project.org/web/packages/RhpcBLASctl/index.html"><code>RhpcBLASctl</code></a>
package:</p>
<div class="sourceCode" id="cb21"><pre
class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RhpcBLASctl)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">blas_get_num_procs</span>()</span></code></pre></div>
<pre class="bg-success"><code>## [1] 12</code></pre>
<div class="sourceCode" id="cb23"><pre
class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">omp_get_num_procs</span>()</span></code></pre></div>
<pre class="bg-success"><code>## [1] 20</code></pre>
<p>If either of these results is greater than 1, then you have
multithreading enabled. We won’t delve into the differences between BLAS
and OMP here; suffice it so say that you want both of these at 1 for
single-threaded matrix operations. <span style="color: red;"><strong>IF
YOU USE <a href="https://mran.microsoft.com/open">MICROSOFT’S
R-OPEN</a></strong>, <strong><em>then you probably have MKL enabled as
your BLAS/LAPACK library, and multi-threading is likely enabled by
default</em></strong></span>.</p>
<p>Alternatively, you can check on the name of your BLAS library, which
will tell you at least if its not the default library:</p>
<div class="sourceCode" id="cb25"><pre
class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()[<span class="fu">c</span>(<span class="st">&quot;BLAS&quot;</span>, <span class="st">&quot;LAPACK&quot;</span>)]</span></code></pre></div>
<pre class="bg-success"><code>## $BLAS
## [1] &quot;/opt/intel/mkl/lib/intel64/libmkl_gf_lp64.so&quot;
## 
## $LAPACK
## [1] &quot;/opt/intel/mkl/lib/intel64/libmkl_gf_lp64.so&quot;</code></pre>
<p>but this isn’t conclusive, as it merely tells us that I’m using MKL,
not that MKL is currently set to use multiple threads. For that reason,
the <code>RhpcBLASctl</code> method is probably superior.</p>
<p><br />
</p>
</div>
<div id="multi-threaded-packages" class="section level3">
<h3>Multi-threaded Packages</h3>
<hr />
<p>In addition to multi-threaded matrix operations, there are other R
packages that are multi-threaded by default and will therefore compete
for CPU resources. The number one culprit here is probably <a
href="https://cran.r-project.org/web/packages/data.table/index.html"><code>data.table</code></a>.
However, other machine learning libraries have the option for
multithreading as well, such as <a
href="https://topepo.github.io/caret/"><code>caret</code></a>, and <a
href="https://cran.r-project.org/web/packages/glmnet/index.html"><code>glmnet</code></a>.
To my knowledge neither of these last two are multithreaded by default,
so this only becomes a problem if you accidentally tell them to use more
than one CPU. In any case, if you run some simulations and notice that
your CPU usage is at zero and you know that you’re not multi-threading
for BLAS/LAPACK, then I would do a hard restart on you computer. If the
problem persists, I would check into the details of the packages you’re
using as its likely that one is multi-threaded by default.</p>
<p><br />
</p>
</div>
<div id="solving-thread-competition" class="section level3">
<h3>Solving Thread Competition</h3>
<hr />
<p>Fortunately, it is extremely easy to solve thread competition.</p>
<ol style="list-style-type: decimal">
<li><p>To disable <em>multi-threaded matrix operations</em>, use the <a
href="https://cran.r-project.org/web/packages/RhpcBLASctl/index.html"><code>RhpcBLASctl</code></a>
package, <span style="color: red;"><strong>and be sure to disable
multi-threading in your loop code as seen below, not just outside of
it:</strong></span></p>
<div class="sourceCode" id="cb27"><pre
class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="do">### disable in parent process </span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RhpcBLASctl)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(doRNG)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="fu">blas_set_num_threads</span>(<span class="dv">1</span>)</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="fu">omp_set_num_threads</span>(<span class="dv">1</span>)</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>ncores <span class="ot">=</span> <span class="dv">3</span> </span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>nsims <span class="ot">=</span> <span class="dv">3</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>cl <span class="ot">=</span> <span class="fu">makeCluster</span>(ncores)</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a><span class="fu">registerDoParallel</span>(cl)</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a><span class="do">### disable in child processes </span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a><span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span>nsims,</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">.packages =</span> <span class="st">&quot;RhpcBLASctl&quot;</span>         <span class="co"># Dont forget to export RhpcBLASCtl pkg</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%dorng%</span> {</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>        <span class="fu">library</span>(RhpcBLASctl)</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>        <span class="fu">blas_set_num_threads</span>(<span class="dv">1</span>)         <span class="co"># DISABLE WITHIN LOOP HERE</span></span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>        <span class="fu">omp_set_num_threads</span>(<span class="dv">1</span>)</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rnorm</span>(<span class="dv">1</span>) </span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a><span class="fu">stopCluster</span>(cl)</span></code></pre></div>
<p><br></p></li>
<li><p>To disable <em>packaged multithreading</em>, you’ll just have to
read the documentation for that package to determine how to set the max
number of threads to 1. For example, browsing the documentation for
<code>data.table</code> immediately tells us that the
<code>setDTthreads()</code> function does what we want.</p></li>
</ol>
<p><br />
</p>
</div>
<div id="caveats" class="section level3">
<h3>Caveats</h3>
<hr />
<p>There are a few qualifiers worth mentioning here.</p>
<ol style="list-style-type: decimal">
<li><p>If you aren’t using matrix operations in your parallel tasks,
then multi-threaded matrix operations shouldn’t cause problems in
theory, because they aren’t even being attempted. However, if they
aren’t happening, it also doesn’t hurt to just set the number of threads
to 1. Just make sure the change it back if you want to leverage that
efficiency in your R session later on.</p></li>
<li><p>If you aren’t using the multi-threaded R packages, perhaps it
goes without saying that you don’t need to worry about them competing
for resources in this way.</p></li>
<li><p>It is possible that some combination of matrix or package
multithreading along with parallel simulations is “optimal,” in the
sense that its faster. For example, if you have 16 threads you could
assign 5 threads to <code>foreach</code>, and then have each of those
processes use 2 threads for matrix operations. You’d then have 15
threads in use, plus one for R-studio or other tasks on reserve. Perhaps
this would be faster overall than single-threaded matrix operations on
15 simulation processes. I haven’t done any testing for this, so I have
no idea whether or when this would be better. At the extreme, it could
in theory be better to use a single threaded simulation (i.e., serial
simulations), while using all cores for matrix operations. I imagine
that is an edge case, but again I cannot rule it out as I have not
investigated this extensively. In any case, I’m lazy, so I just disable
multi-threading on all packages and matrix operations, and give all my
threads to <code>foreach</code>.</p></li>
</ol>
<p><br />
</p>
</div>
</div>
<div id="parameter-grids" class="section level1">
<h1>Parameter Grids</h1>
<hr />
<p>Now that we’re working in parallel without suffering thread
competition and can consistently reproduce our results, the next step is
to create a grid of parameters for our simulations, i.e., the points in
the parameter space at which we’ll investigate the behavior of our
chosen procedure. These will of course be specific to the process under
study, but its worth showing a general way to go about creating this
grid.</p>
<p>As a contrived toy example, suppose our task involves normal random
variables with different means and variances. Specifically, we are
interested in <span class="math inline">\(X \sim \mathcal{N}\left(\mu
\in \{0, -1 \}, \,\,\sigma^2 \in \{1, 3\}\right)\)</span>; that is,
we’ll vary the mean and variance of some random variable <span
class="math inline">\(X\)</span>. Additionally, we want to investigate
how sample size affects the properties of these random draws. Right now
its not important <em>why</em> we’re doing this or what <span
class="math inline">\(X\)</span> will be used for, only that we want
random variables with every pairwise combination of these parameter
values.</p>
<p>To do so, we create vectors of these parameters, and then use
<code>expand.grid()</code> to get the pairwise combinations:</p>
<div class="sourceCode" id="cb28"><pre
class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>mu <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>sig2 <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>n <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">10</span>)</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>(<span class="at">grid =</span> <span class="fu">expand.grid</span>(<span class="at">mu =</span> mu, <span class="at">sig2 =</span> sig2, <span class="at">n =</span> n))</span></code></pre></div>
<pre class="bg-success"><code>##   mu sig2  n
## 1  0    1  5
## 2 -1    1  5
## 3  0    3  5
## 4 -1    3  5
## 5  0    1 10
## 6 -1    1 10
## 7  0    3 10
## 8 -1    3 10</code></pre>
<p>So now we have the parameters we need for our simulations in a nice
tabular format, which we can then loop over when creating data from our
chosen data generating process. For example (omitting the back-end
setup, etc. for clarity):</p>
<div class="sourceCode" id="cb30"><pre
class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># SETUP OMITTED FOR SIMPLICITY. SEE EXAMPLES SECTION FOR FULL SETUP. </span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>out <span class="ot">=</span> <span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(grid)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%dopar%</span> {</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rnorm</span>( <span class="at">n =</span> grid[i, <span class="st">&quot;n&quot;</span>],</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>           <span class="at">mean =</span> grid[i, <span class="st">&quot;mu&quot;</span>],</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>           <span class="at">sd =</span> <span class="fu">sqrt</span>(grid[i, <span class="st">&quot;sig2&quot;</span>])</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(out)</span></code></pre></div>
<pre class="bg-success"><code>## [[1]]
## [1]  0.8005543  1.1902066 -1.6895557  1.2394959 -0.1089660
## 
## [[2]]
## [1] -1.1172420 -0.8169174  0.2805549 -2.7272706  0.6901844
## 
## [[3]]
## [1]  0.8726288  4.3792074  0.9510634  0.4125969 -1.8167362
## 
## [[4]]
## [1]  1.242596  0.429877 -1.096451 -2.358590 -2.270465
## 
## [[5]]
##  [1] -0.21586539 -0.33491276 -1.08569914 -0.08542326  1.07061054 -0.14539355
##  [7] -1.16554485 -0.81851572  0.68493608 -0.32005642
## 
## [[6]]
##  [1] -2.3115224 -1.5996083 -1.1294107 -0.1132639 -1.1513960 -0.6702088
##  [7] -4.2273228 -1.7717918 -0.7134514 -2.2205120</code></pre>
<p>The main point here is that we’ve created a <code>grid</code> of all
unique pairwise parameter combinations, and we’ve looped over each row
of that <code>grid</code> to then get random numbers using every
possible parameter combination. In this way we’ve ensured that we
simulate data from each of the desired parameterizations, all without
having to manually specify the parameters, and without having to do any
sort of nested looping,
e.g. <code>for(i in mu){ for j in sig2 {...}}</code>. This is akin to a
grid-search in optimization, although here we’re not searching for an
optimal set of parameters, we’re investigating the behavior of some
procedure at pre-defined grid points in the parameter space.</p>
<p><br />
</p>
<div id="extending-grids-to-multiple-simulations"
class="section level3">
<h3>Extending Grids to Multiple Simulations</h3>
<hr />
<p>Of course, <em>we’ve only done one simulation</em> here. That is, at
each set of parameter values, we have one iteration. But in Monte Carlo
analysis, we want some large number of simulations in order to see how
things are behaving, so we’ll need to replicate this grid. Suppose we
want 2 simulations instead of 1, then we can use <code>do.call()</code>,
<code>cbind.data.frame</code>, and <code>replicate()</code> together to
get a grid with each grid point appearing twice, so that we’ll have two
simulations at that point instead of one:</p>
<div class="sourceCode" id="cb32"><pre
class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>nsims <span class="ot">=</span> <span class="dv">2</span> </span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>mu <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>sig2 <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>)</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>n <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">10</span>)</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>grid <span class="ot">=</span> <span class="fu">expand.grid</span>(<span class="at">mu =</span> mu, <span class="at">sig2 =</span> sig2, <span class="at">n =</span> n)</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>(<span class="at">grid_multi =</span> <span class="fu">do.call</span>(rbind.data.frame, <span class="fu">replicate</span>(nsims, grid, <span class="at">simplify=</span>F)))</span></code></pre></div>
<pre class="bg-success"><code>##    mu sig2  n
## 1   0    1  5
## 2  -1    1  5
## 3   0    3  5
## 4  -1    3  5
## 5   0    1 10
## 6  -1    1 10
## 7   0    3 10
## 8  -1    3 10
## 9   0    1  5
## 10 -1    1  5
## 11  0    3  5
## 12 -1    3  5
## 13  0    1 10
## 14 -1    1 10
## 15  0    3 10
## 16 -1    3 10</code></pre>
<p>And we can now see that each grid point appears twice, so if we were
to loop over this in the same as as we did previously, we produce
results for each parameter combination twice. Inductively then, we know
that for arbitrary values of <code>nsims</code>, we’ll get
<code>nsims</code>-many results for each parameter combination, which is
precisely what we want in Monte Carlo analysis.</p>
<p>Briefly explaining the above code, <code>replicate()</code> is
replicating the <code>grid</code> dataframe <code>nsims</code>-many
times, and storing these replicates in a list. Then,
<code>do.call</code> calls the <code>rbind.data.frame</code> function
with each element of the replicated list as its arguments.
Mathematically, <code>do.call</code> is effectively executing <span
class="math inline">\(f(x_1, x_2, ..., x_{nsims})\)</span> where <span
class="math inline">\(f()\)</span> is <code>rbind.data.frame</code>, and
each <code>x_j</code> is an element of a list. In this case, the
list-elements are all the original, single-simulation <code>grid</code>
object.</p>
<p><br />
</p>
</div>
<div id="why-not-use-a-nested-loop" class="section level3">
<h3>Why not use a nested loop?</h3>
<hr />
<p>One potential question is why not use a nested loop instead of
replicating each grid point <code>nsims</code>-many times. That is, we
could just repeatedly loop over the original <code>grid</code> object,
rather than replicating it several times, like so (omitting the back-end
setup, etc. for clarity):</p>
<div class="sourceCode" id="cb34"><pre
class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># SETUP OMITTED FOR CLARITY. SEE ENDING EXAMPLES FOR FULL SETUP.</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Make grid WITHOUT REPLICATING </span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>mu <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>sig2 <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="fl">1.5</span>)</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>n <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">10</span>)</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>grid <span class="ot">=</span> <span class="fu">expand.grid</span>(<span class="at">mu =</span> mu, <span class="at">sig2 =</span> sig2, <span class="at">n =</span> n)</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a><span class="co"># make number of simulations a variable for looping</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>nsims <span class="ot">=</span> <span class="dv">2</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>out <span class="ot">=</span> <span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(grid)</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%dopar%</span> {</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>    res <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># create an inner, nested loop that repeatedly simulates from a gridpoint</span></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># instead of replicating the gridpoint and looping over the replicates</span></span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(j <span class="cf">in</span> <span class="fu">seq_len</span>(nsims)){</span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>      res[[j]] <span class="ot">=</span> <span class="fu">rnorm</span>( <span class="at">n =</span> grid[i, <span class="st">&quot;n&quot;</span>],</span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>                      <span class="at">mean =</span> grid[i, <span class="st">&quot;mu&quot;</span>],</span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>                      <span class="at">sd =</span> <span class="fu">sqrt</span>(grid[i, <span class="st">&quot;sig2&quot;</span>])</span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>                      )</span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(res)</span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a>out[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>]</span></code></pre></div>
<pre class="bg-success"><code>## [[1]]
## [[1]][[1]]
## [1] -0.4682005 -0.7729782  2.1499193 -1.3343536  0.4958705
## 
## [[1]][[2]]
## [1]  1.2339762  0.6343621  0.4120223  0.7935853 -0.1524106
## 
## 
## [[2]]
## [[2]][[1]]
## [1] -1.2288958 -1.9007918 -1.7350262 -2.4276858 -0.3807165
## 
## [[2]][[2]]
## [1] -1.006198 -1.685707 -1.279334 -1.782730 -1.778997
## 
## 
## [[3]]
## [[3]][[1]]
## [1] -0.4590345 -0.3911759  0.1035445 -0.9411841 -0.7665812
## 
## [[3]][[2]]
## [1] -1.10333696  0.81289828  0.36776531  0.09168051  0.25275390</code></pre>
<p>The key difference here is that we create a single set of grid points
without duplication (i.e., without using <code>replicate()</code>), and
then create an inner loop— <code>for(j in seq_len(nsims))</code>—that
repeatedly uses these grid points <code>nsims</code>-many times. An
obvious advantage of the nested-loop approach is that it conserves
memory; the grid is not replicated, so each core only stores a copy of
the original, single-simulation grid. The memory gains are somewhat
trivial though due to how R stores lists in memory, but that is a
technical aside that I won’t delve into now (see <a
href="https://adv-r.hadley.nz/vectors-chap.html#lists">this page</a> for
more info).</p>
<p>However, <strong>the major disadvantage of the nested-loop approach
is load balancing</strong>. In most real-world applications we will be
varying the sample size of our procedure, and by much more than we are
doing so here; i.e., we’ll estimate some model at small and large sample
sizes. In doing so, the nested-loop approach becomes problematic for
load balancing purposes, because the CPUs that have the small sample
sizes will take way less time to complete their inner, nested loop
(recall, the set of instructions on the right-hand side of
<code>%dopar%</code> are executed on a single CPU). Eventually then, the
CPUs with the large sample sizes will still be running their nested,
inner-loops while the CPUs that had the smaller sample sizes have
completed their tasks and are <em>sitting idle</em> doing nothing.<br />
</p>
</div>
<div id="caveats-1" class="section level3">
<h3>Caveats</h3>
<hr />
<p>In most cases, the replicated-grid approach will be better, often
times by several hours when compared with the parallel-outer,
serial-inner approach. However, there are at least two instances where
this won’t hold.</p>
<ol style="list-style-type: decimal">
<li><p>If the run-time of a single simulation is small, e.g., &lt; 1
second, it is possible that the overhead from parallelizing at the
simulation level—rather than the grid-point level—will exceed the gains
from parallelizing. This is known as <a
href="https://en.wikipedia.org/wiki/Parallel_slowdown">parallel slow
down</a>. It’s possible to mitigate this by using prescheduling, but
even this won’t always fix the issue if single simulations take a very
small amount of time. Prescheduling splits the total number of tasks
into chunks (at random) and assigns these tasks to each CPU. So if you
allocate 10 CPUs, and there are 100 tasks, the computer will randomly
select 10 tasks to assign to each CPU. Without prescheduling, when a CPU
finishes a task, it will communicate with the other CPUs in the network
or the parent process and determine what tasks still need doing, and
then it does one of the ones that remains. So, by prescheduling we
reduce some of this communication overhead. There are advantages and
disadvantages to prescheduling that I won’t go into here, but a general
rule is if your tasks are numerous and require little time individually,
use prescheduling, otherwise don’t. To enable presheduling in
<code>foreach</code>, do the following:</p>
<div class="sourceCode" id="cb36"><pre
class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span>nsims, </span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">.options.multicore =</span> <span class="fu">list</span>(<span class="at">preschedule =</span> <span class="cn">TRUE</span>)) </span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    <span class="sc">%dorng%</span> {</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>      [...code...]</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    }</span></code></pre></div></li>
<li><p>If you are doing some form of Markov Chain Monte Carlo (MCMC),
rather than traditional Monte Carlo analysis, the nested loop approach
will generally become <strong><em>necessary</em></strong>. For things
like the Metropolis-Hastings algorithm and its derivatives (e.g.,
Metropolis, Gibbs), we are typically sampling from a full-conditional
distribution that depends on some previous iteration. So parallelization
here would occur at the chain-level, and within each chain we would have
serial loops to sample from the full conditionals. The gridding approach
would also not make as much sense anyway, as the proposal parameters are
not fixed ex-ante aside from the starting values.</p></li>
</ol>
<p><br />
</p>
</div>
</div>
<div id="using-functions-properly" class="section level1">
<h1>Using Functions Properly</h1>
<hr />
<p>At this point we’ve set up our environment, and are ready to start
with the actual simulations. To recap, we are using <code>foreach</code>
combined with <code>%dopar%</code> or <code>%dorng%</code> for
parallelism, we’ve ensured reproducability, we have handled thread
competition with other parallel processes, and now we have a grid of
parameter values at which to investigate the behavior of some procedure,
with each grid value appearing once for each simulation iteration. Now
we can make some functions that will automate the simulation and
transformation of our data.</p>
<p>R is an object oriented, functional programming language. We should
leverage both of these facts to make our simulations easier to
understand, implement, and debug. At a minimum, this will consist of
having two functions:</p>
<ol style="list-style-type: decimal">
<li><p>A <strong>simulation function</strong> that creates the data to
be further analyzed.</p></li>
<li><p>An <strong>estimation/analysis function</strong> that estimates
the model(s) that we want, and tidies the results for us.</p></li>
</ol>
<p>We could optionally further separate the estimation function (2) into
two functions, one for estimation and the other for tidying, rather than
combining these steps.</p>
<p>This approach to Monte Carlo analysis—having a simulation function,
and an estimation function—is one of the most important reasons why I
choose not to use the parallelized <code>apply</code> family of
functions. If you’re unfamiliar with the <code>apply</code> family of
functions, you can either skip this paragraph or <a
href="https://www.r-bloggers.com/2015/07/r-tutorial-on-the-apply-family-of-functions/">familiarize
yourself</a> with them. Because our data must be both simulated and then
used in estimation, the <code>apply</code> family of functions requires
that there be either (i) a single function that does both of these tasks
(e.g., via nesting), or (ii) that we pre-simulate every single dataset
that will be needed for the estimation procedure, and then call the
estimation function on each of them using <code>apply</code>
functionality. The first approach is bad because debugging functions
becomes more nightmarish as they get more complicated, so smooshing two
functions into one is ill-advised. The second approach is unfeasible in
most interesting cases because there is usually not enough memory to
store hundreds of thousands of pre-simulated datasets. Thus, because
we’ll compartmentalize the simulation and estimation into two functions,
the <code>foreach</code> approach becomes the natural one to
implement.</p>
<p><br />
</p>
<div id="simulation-function" class="section level3">
<h3>Simulation Function</h3>
<hr />
<p>The goal of the simulation function is to take in one row from our
parameter grid, and use those parameters to create a dataset that will
eventually be transformed via estimation or some other procedure of
interest. Keeping with the toy example used previously, lets suppose we
are just simulating some realizations of a normal random variable at
various grid points and sample sizes. We have our grid from earlier:</p>
<div class="sourceCode" id="cb37"><pre
class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(grid_multi)</span></code></pre></div>
<pre class="bg-success"><code>##    mu sig2  n
## 1   0    1  5
## 2  -1    1  5
## 3   0    3  5
## 4  -1    3  5
## 5   0    1 10
## 6  -1    1 10
## 7   0    3 10
## 8  -1    3 10
## 9   0    1  5
## 10 -1    1  5
## 11  0    3  5
## 12 -1    3  5
## 13  0    1 10
## 14 -1    1 10
## 15  0    3 10
## 16 -1    3 10</code></pre>
<p>which has 3 parameters, <code>mu</code>, <code>sig2</code> and
<code>n</code>. So our simulation function will have to take in <em>at
least</em> these parameters, and potentially others. It is my view that
the easiest way to do this is just to take in a vector of parameters as
a single parameter to the function, rather than explicitly naming each
parameter to the function. This way, if the grid columns change, we
don’t have to then go and add or remove parameters from the simulation
function.</p>
<p>For example, we could specify the parameters explicitly, then index
our grid by row when passing the arguments (in this case, just row
1):</p>
<div class="sourceCode" id="cb39"><pre
class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>simulate_fn <span class="ot">=</span> <span class="cf">function</span>(mu, sig2, n){</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">mu =</span> mu, </span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">sig2 =</span> sig2, </span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">n =</span> n</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a><span class="fu">simulate_fn</span>(</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">mu =</span> grid_multi[<span class="dv">1</span>, <span class="st">&quot;mu&quot;</span>], </span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">sig2 =</span> grid_multi[<span class="dv">1</span>, <span class="st">&quot;sig2&quot;</span>],</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> grid_multi[<span class="dv">1</span>, <span class="st">&quot;n&quot;</span>]</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
<pre class="bg-success"><code>## $mu
## [1] 0
## 
## $sig2
## [1] 1
## 
## $n
## [1] 5</code></pre>
<p>But if we later decide we want to add new parameter to the grid, we
then have to update the <code>simulate_fn</code> function accordingly.
Updating the function’s parameters can be avoided if we just pass a
named parameter vector as a single parameter, and unpack it inside the
function:</p>
<div class="sourceCode" id="cb41"><pre
class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>simulate_fn <span class="ot">=</span> <span class="cf">function</span>(grid_row){</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  grid_row <span class="ot">=</span> <span class="fu">unlist</span>(grid_row) <span class="co"># re-class to vector from data.frame</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">mu =</span> grid_row[<span class="st">&quot;mu&quot;</span>], </span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">sig2 =</span> grid_row[<span class="st">&quot;sig2&quot;</span>], </span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">n =</span> grid_row[<span class="st">&quot;n&quot;</span>]</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a><span class="fu">simulate_fn</span>(grid_multi[<span class="dv">1</span>,])</span></code></pre></div>
<pre class="bg-success"><code>## $mu
## mu 
##  0 
## 
## $sig2
## sig2 
##    1 
## 
## $n
## n 
## 5</code></pre>
<p><br />
</p>
<p>Using this second approach then, we can define a function to simulate
the normal realizations, and see what it produces for a single iteration
on our grid:</p>
<div class="sourceCode" id="cb43"><pre
class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>simulate_fn <span class="ot">=</span> <span class="cf">function</span>(grid_row){</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  grid_row <span class="ot">=</span> <span class="fu">unlist</span>(grid_row)</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rnorm</span>(</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> grid_row[<span class="st">&quot;n&quot;</span>], </span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean =</span> grid_row[<span class="st">&quot;mu&quot;</span>],</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">sd =</span> <span class="fu">sqrt</span>(grid_row[<span class="st">&quot;sig2&quot;</span>])</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a><span class="fu">simulate_fn</span>(<span class="at">grid_row =</span> grid_multi[<span class="dv">1</span>,])</span></code></pre></div>
<pre class="bg-success"><code>## [1] -0.86756612 -0.50118759  0.78559116 -2.10224732 -0.04220493</code></pre>
<p>which is a numeric vector, as we would expect. Now we can do whatever
transformation of this data to obtain statistics of interest for each
iteration. However, we’ll need an estimation function first.</p>
<p> </p>
</div>
<div id="estimation-function" class="section level3">
<h3>Estimation Function</h3>
<hr />
<p>The goal of the estimation function is to take in the data simulated
from the simulation function (<code>simulate_fn()</code>, previously),
and carry out whatever procedure on that data we are interested in
analyzing via the Monte Carlo method. To keep up the toy example, lets
say now that we’re interested in the estimators of the first and second
moments of a normal random variable after we’ve exponentiated it (that
is, of the log-normal distribution). So we’ll need a function that takes
in the data, exponentiates it, and computes these estimates.
<strong>Importantly,</strong> we want to know how the various parameters
under consideration impact these estimators (if at all), so we need to
also keep track of the parameters that we’re using to generate the data
for each iteration. One possibility is the following, where we again
pass in the data-generating grid row:</p>
<div class="sourceCode" id="cb45"><pre
class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>estimate_fn <span class="ot">=</span> <span class="cf">function</span>(dat, grid_row){</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  dat_exp <span class="ot">=</span> <span class="fu">exp</span>(dat)</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  xbar <span class="ot">=</span> <span class="fu">mean</span>(dat_exp)</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>  s2   <span class="ot">=</span> <span class="fu">var</span>(dat_exp)</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">=</span> <span class="fu">c</span>(<span class="at">xbar =</span> xbar, <span class="at">s2 =</span> s2, grid_row)</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(out)</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><br />
</p>
<p>So now we’ll simulate some data using <code>simulate_fn</code> at a
single grid-point, <code>grid_multi[1,]</code>, and return the
quantities of interest from this data using the
<code>estimate_fn()</code>:</p>
<div class="sourceCode" id="cb46"><pre
class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>grid_row <span class="ot">=</span> <span class="fu">unlist</span>(grid_multi[<span class="dv">1</span>,])</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">=</span> <span class="fu">simulate_fn</span>(<span class="at">grid_row =</span> grid_row)</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="fu">estimate_fn</span>(</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">dat =</span> dat, </span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">grid_row =</span> grid_row</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<pre class="bg-success"><code>##     xbar       s2       mu     sig2        n 
## 2.945893 9.805178 0.000000 1.000000 5.000000</code></pre>
<p>which gives us the sample mean and variance for a single iteration of
transforming data to log-normal realizations, as well as stores the
data-generating parameters for use in post-simulation analysis.
Inductively, we can imagine doing this for all rows in our grid, which
would give us results for all parameter comibinations multiple times. We
could then analyze these results graphically or otherwise. The next
section puts all of this together in a comprehensive toy example.</p>
<p> </p>
</div>
</div>
<div id="putting-it-all-together" class="section level1">
<h1>Putting it All Together</h1>
<hr />
<p>Before we jump into some more serious examples, we can combine
everything we’ve learned using the toy example, just to give an idea
about the structure. I’m not going to separate the code out for each
step we’ve covered; all of it will appear in a single chunk with
comments so as to mimic what we would actually have in a script. I’ll
also be doing things in a slightly different order than was presented in
the guide for computational and presentation purposes. This is again for
the example of analyzing the estimators of the first two moments of the
log-normal distribution under various parameterizations. I’ll do 30
simulations at each grid point for demonstration purposes, but in
reality you’d probably want more.</p>
<div class="sourceCode" id="cb48"><pre
class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load up packages </span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>pks <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;doParallel&quot;</span>, <span class="st">&quot;doRNG&quot;</span>, <span class="st">&quot;RhpcBLASctl&quot;</span>)</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>needed <span class="ot">=</span> <span class="fu">setdiff</span>(pks, <span class="fu">rownames</span>(<span class="fu">installed.packages</span>()))</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">length</span>(needed) <span class="sc">&gt;</span> <span class="dv">1</span>)</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">install.packages</span>(pks, <span class="at">Ncpus =</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>() <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a><span class="fu">invisible</span>(<span class="fu">sapply</span>(pks, library, <span class="at">character.only=</span>T))</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Define Simulation and Estimation Functions</span></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>simulate_fn <span class="ot">=</span> <span class="cf">function</span>(grid_row){</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rnorm</span>(</span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> grid_row[<span class="st">&quot;n&quot;</span>], </span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean =</span> grid_row[<span class="st">&quot;mu&quot;</span>],</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">sd =</span> <span class="fu">sqrt</span>(grid_row[<span class="st">&quot;sig2&quot;</span>])</span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a>estimate_fn <span class="ot">=</span> <span class="cf">function</span>(dat, grid_row){</span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a>  dat_exp <span class="ot">=</span> <span class="fu">exp</span>(dat)</span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a>  xbar <span class="ot">=</span> <span class="fu">mean</span>(dat_exp)</span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a>  s2   <span class="ot">=</span> <span class="fu">var</span>(dat_exp)</span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">=</span> <span class="fu">c</span>(<span class="at">xbar =</span> xbar, <span class="at">s2 =</span> s2, grid_row)</span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(out)</span>
<span id="cb48-30"><a href="#cb48-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb48-31"><a href="#cb48-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-32"><a href="#cb48-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Make the parameter grid </span></span>
<span id="cb48-33"><a href="#cb48-33" aria-hidden="true" tabindex="-1"></a>nsims <span class="ot">=</span> <span class="dv">300</span> </span>
<span id="cb48-34"><a href="#cb48-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-35"><a href="#cb48-35" aria-hidden="true" tabindex="-1"></a>mu <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb48-36"><a href="#cb48-36" aria-hidden="true" tabindex="-1"></a>sig2 <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>)</span>
<span id="cb48-37"><a href="#cb48-37" aria-hidden="true" tabindex="-1"></a>n <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">10</span>)</span>
<span id="cb48-38"><a href="#cb48-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-39"><a href="#cb48-39" aria-hidden="true" tabindex="-1"></a>grid <span class="ot">=</span> <span class="fu">expand.grid</span>(<span class="at">mu =</span> mu, <span class="at">sig2 =</span> sig2, <span class="at">n =</span> n)</span>
<span id="cb48-40"><a href="#cb48-40" aria-hidden="true" tabindex="-1"></a>grid_multi <span class="ot">=</span> <span class="fu">do.call</span>(rbind.data.frame, <span class="fu">replicate</span>(nsims, grid, <span class="at">simplify=</span>F))</span>
<span id="cb48-41"><a href="#cb48-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-42"><a href="#cb48-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Disable BLAS/LAPACK multithreading in parent process </span></span>
<span id="cb48-43"><a href="#cb48-43" aria-hidden="true" tabindex="-1"></a><span class="fu">blas_set_num_threads</span>(<span class="dv">1</span>)</span>
<span id="cb48-44"><a href="#cb48-44" aria-hidden="true" tabindex="-1"></a><span class="fu">omp_set_num_threads</span>(<span class="dv">1</span>)</span>
<span id="cb48-45"><a href="#cb48-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-46"><a href="#cb48-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Spin up backend</span></span>
<span id="cb48-47"><a href="#cb48-47" aria-hidden="true" tabindex="-1"></a>nprocs <span class="ot">=</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>() <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb48-48"><a href="#cb48-48" aria-hidden="true" tabindex="-1"></a>os <span class="ot">=</span> .Platform<span class="sc">$</span>OS.type</span>
<span id="cb48-49"><a href="#cb48-49" aria-hidden="true" tabindex="-1"></a>type <span class="ot">=</span> <span class="cf">if</span>(<span class="fu">grepl</span>(<span class="st">&#39;unix&#39;</span>, os)) <span class="st">&#39;FORK&#39;</span> <span class="cf">else</span> <span class="st">&#39;PSOCK&#39;</span></span>
<span id="cb48-50"><a href="#cb48-50" aria-hidden="true" tabindex="-1"></a>cl <span class="ot">=</span> <span class="fu">makeCluster</span>(nprocs, <span class="at">type =</span> type)</span>
<span id="cb48-51"><a href="#cb48-51" aria-hidden="true" tabindex="-1"></a><span class="fu">registerDoParallel</span>(cl)</span>
<span id="cb48-52"><a href="#cb48-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-53"><a href="#cb48-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Run sims </span></span>
<span id="cb48-54"><a href="#cb48-54" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb48-55"><a href="#cb48-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-56"><a href="#cb48-56" aria-hidden="true" tabindex="-1"></a>res <span class="ot">=</span> <span class="fu">foreach</span>(<span class="at">i =</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(grid_multi)),</span>
<span id="cb48-57"><a href="#cb48-57" aria-hidden="true" tabindex="-1"></a>              <span class="at">.packages =</span> <span class="st">&#39;RhpcBLASctl&#39;</span>,</span>
<span id="cb48-58"><a href="#cb48-58" aria-hidden="true" tabindex="-1"></a>              <span class="at">.errorhandling =</span> <span class="st">&quot;pass&quot;</span>,</span>
<span id="cb48-59"><a href="#cb48-59" aria-hidden="true" tabindex="-1"></a>              <span class="at">.inorder =</span> F,</span>
<span id="cb48-60"><a href="#cb48-60" aria-hidden="true" tabindex="-1"></a>              <span class="at">.options.multicore =</span> <span class="fu">list</span>(<span class="at">preschedule=</span>T)</span>
<span id="cb48-61"><a href="#cb48-61" aria-hidden="true" tabindex="-1"></a>              ) <span class="sc">%dorng%</span> {</span>
<span id="cb48-62"><a href="#cb48-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb48-63"><a href="#cb48-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">blas_set_num_threads</span>(<span class="dv">1</span>)</span>
<span id="cb48-64"><a href="#cb48-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">omp_set_num_threads</span>(<span class="dv">1</span>)</span>
<span id="cb48-65"><a href="#cb48-65" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-66"><a href="#cb48-66" aria-hidden="true" tabindex="-1"></a>  grid_row <span class="ot">=</span> <span class="fu">unlist</span>(grid_multi[i,])</span>
<span id="cb48-67"><a href="#cb48-67" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb48-68"><a href="#cb48-68" aria-hidden="true" tabindex="-1"></a>  dat <span class="ot">=</span> <span class="fu">simulate_fn</span>(grid_row)</span>
<span id="cb48-69"><a href="#cb48-69" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">=</span> <span class="fu">estimate_fn</span>(dat, grid_row)</span>
<span id="cb48-70"><a href="#cb48-70" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-71"><a href="#cb48-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(out)</span>
<span id="cb48-72"><a href="#cb48-72" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-73"><a href="#cb48-73" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb48-74"><a href="#cb48-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-75"><a href="#cb48-75" aria-hidden="true" tabindex="-1"></a><span class="fu">stopCluster</span>(cl)</span>
<span id="cb48-76"><a href="#cb48-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-77"><a href="#cb48-77" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(res)</span></code></pre></div>
<pre class="bg-success"><code>## [[1]]
##      xbar        s2        mu      sig2         n 
## 1.3026862 0.3935615 0.0000000 1.0000000 5.0000000 
## 
## [[2]]
##        xbar          s2          mu        sig2           n 
##  0.34552657  0.03082885 -1.00000000  1.00000000  5.00000000 
## 
## [[3]]
##     xbar       s2       mu     sig2        n 
##  4.48814 29.04685  0.00000  3.00000  5.00000 
## 
## [[4]]
##     xbar       s2       mu     sig2        n 
##  3.73561 59.18659 -1.00000  3.00000  5.00000 
## 
## [[5]]
##      xbar        s2        mu      sig2         n 
##  2.091634 20.764002  0.000000  1.000000 10.000000 
## 
## [[6]]
##       xbar         s2         mu       sig2          n 
##  0.7508876  0.7733243 -1.0000000  1.0000000 10.0000000</code></pre>
<p><br />
</p>
</div>
<div id="example-bias-of-ar1-model" class="section level1">
<h1>Example: Bias of AR(1) Model</h1>
<hr />
<p>In this example I will utlize the steps outlined previously to show
that order-1 time-series autoregressive models (AR(1) models) have
biased estimators of the autoregressive parameter. This can be shown
theoretically, as well, but pretend for the moment that we don’t know
such a closed form solution exists, or perhaps we’re too lazy to find
one. The Monte Carlo method is well suited for the task.</p>
<p>Briefly, AR(1) models assume a data generating process of the form
<span class="math display">\[ y_t = \rho y_{t-1} + \varepsilon_t
\]</span> where <span class="math inline">\(t = 1, 2, ..., T\)</span>
indexes a time period, <span class="math inline">\(|\rho| &lt;
1\)</span>, and for the time being we’ll assume that <span
class="math inline">\(\varepsilon_t \overset{iid}{\sim} \mathcal{N}(0,
1)\)</span>, although with large enough sample sizes normality is not
required. Then we can estimate <span class="math inline">\(\rho\)</span>
by <span class="math display">\[\hat\rho = \frac{\sum_t (y_t - \bar
y)(y_{t-1} - \bar y)}{\sum_t (y_{t-1} - \bar y)^2}\]</span> that is, by
using its (ordinary) least squares estimator (which is also the sample
autocorrelation function).</p>
<p>Using the Monte Carlo method, we will show that <span
class="math inline">\(\mathbb{E}(\hat\rho) - \rho \neq 0\)</span>,
meaning that <span class="math inline">\(\hat\rho\)</span> is biased. In
fact, we’ll determine that <span
class="math inline">\(|\mathbb{E}(\hat\rho)| &lt; |\rho|\)</span>,
meaning that the AR parameter is biased towards zero.</p>
<p>In the below, I will simply apply what was discussed in the previous
sections without further discussion. The intention here is to give
example code for more complicated problems, but the principles in
application are identical to those already discussed.</p>
</div>
<div id="helpers" class="section level1">
<h1>Helpers</h1>
</div>
<div id="spurious-regression" class="section level1">
<h1>Spurious Regression</h1>
<div class="sourceCode" id="cb50"><pre
class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="do">### Install and Load the necessary packages (see `Helper Functions`)</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="fu">inst_load</span>()</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="do">### Define BOTH simulation and estimation in single function</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>sim_and_est <span class="ot">=</span> <span class="cf">function</span>(n, iter_id){</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">=</span> y <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>  x[[<span class="dv">1</span>]] <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="dv">1</span>)</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>  y[[<span class="dv">1</span>]] <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="dv">1</span>)</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>n){</span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a>    x[[i]] <span class="ot">=</span>  x[[i<span class="dv">-1</span>]] <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">1</span>)</span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a>    y[[i]] <span class="ot">=</span>  y[[i<span class="dv">-1</span>]] <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">1</span>)</span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">=</span> <span class="fu">unlist</span>(y)</span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">=</span> <span class="fu">unlist</span>(x)</span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a>  mod <span class="ot">=</span> <span class="fu">lm</span>(y <span class="sc">~</span> x)</span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true" tabindex="-1"></a>  sumr <span class="ot">=</span> <span class="fu">summary</span>(mod)</span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb50-26"><a href="#cb50-26" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">=</span> <span class="fu">data.frame</span>(</span>
<span id="cb50-27"><a href="#cb50-27" aria-hidden="true" tabindex="-1"></a>          <span class="at">iter_id =</span> iter_id, </span>
<span id="cb50-28"><a href="#cb50-28" aria-hidden="true" tabindex="-1"></a>          <span class="at">n =</span> n,</span>
<span id="cb50-29"><a href="#cb50-29" aria-hidden="true" tabindex="-1"></a>          <span class="at">est =</span> sumr<span class="sc">$</span>coefficients[<span class="dv">2</span>, <span class="dv">1</span>],</span>
<span id="cb50-30"><a href="#cb50-30" aria-hidden="true" tabindex="-1"></a>          <span class="at">se =</span> sumr<span class="sc">$</span>coefficients[<span class="dv">2</span>, <span class="dv">2</span>],</span>
<span id="cb50-31"><a href="#cb50-31" aria-hidden="true" tabindex="-1"></a>          <span class="at">r2 =</span> sumr<span class="sc">$</span>adj.r.squared</span>
<span id="cb50-32"><a href="#cb50-32" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb50-33"><a href="#cb50-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb50-34"><a href="#cb50-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(out)</span>
<span id="cb50-35"><a href="#cb50-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb50-36"><a href="#cb50-36" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb50-37"><a href="#cb50-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-38"><a href="#cb50-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-39"><a href="#cb50-39" aria-hidden="true" tabindex="-1"></a><span class="do">### Set up grid</span></span>
<span id="cb50-40"><a href="#cb50-40" aria-hidden="true" tabindex="-1"></a>n <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">100</span>, <span class="dv">500</span>, <span class="dv">1000</span>, <span class="dv">10000</span>)</span>
<span id="cb50-41"><a href="#cb50-41" aria-hidden="true" tabindex="-1"></a>nsims <span class="ot">=</span> <span class="dv">1000</span></span>
<span id="cb50-42"><a href="#cb50-42" aria-hidden="true" tabindex="-1"></a>chunks <span class="ot">=</span> <span class="fu">seq</span>(<span class="at">from =</span> nsims, </span>
<span id="cb50-43"><a href="#cb50-43" aria-hidden="true" tabindex="-1"></a>             <span class="at">to =</span> nsims <span class="sc">*</span> <span class="fu">length</span>(n), </span>
<span id="cb50-44"><a href="#cb50-44" aria-hidden="true" tabindex="-1"></a>             <span class="at">by =</span> nsims</span>
<span id="cb50-45"><a href="#cb50-45" aria-hidden="true" tabindex="-1"></a>             )</span>
<span id="cb50-46"><a href="#cb50-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-47"><a href="#cb50-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-48"><a href="#cb50-48" aria-hidden="true" tabindex="-1"></a><span class="do">### Simulate</span></span>
<span id="cb50-49"><a href="#cb50-49" aria-hidden="true" tabindex="-1"></a><span class="fu">setup_cl</span>()</span></code></pre></div>
<pre><code>## Warning in setup_cl(): Cluster or socket connections are already present,
## closing these will be attempted.</code></pre>
<div class="sourceCode" id="cb52"><pre
class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>out <span class="ot">=</span> </span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">foreach</span>(</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">i =</span> <span class="fu">seq_len</span>(<span class="fu">length</span>(n)<span class="sc">*</span>nsims),</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">.options.multicore =</span> <span class="fu">list</span>(<span class="at">preschedule=</span>T),</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">.maxcombine =</span> <span class="fu">length</span>(n)<span class="sc">*</span>nsims,</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">.multicombine =</span> T,</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">.packages =</span> <span class="st">&#39;RhpcBLASctl&#39;</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%dorng%</span> {</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>  RhpcBLASctl<span class="sc">::</span><span class="fu">blas_set_num_threads</span>(<span class="dv">1</span>)</span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>  RhpcBLASctl<span class="sc">::</span><span class="fu">omp_set_num_threads</span>(<span class="dv">1</span>)</span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>  grid_row <span class="ot">=</span> n[<span class="fu">which.max</span>(i <span class="sc">&lt;=</span> chunks)]</span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">=</span> <span class="fu">sim_and_est</span>(grid_row, i)</span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(out)</span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a><span class="fu">clear_cl</span>()</span></code></pre></div>
</div>
<div id="plotting-spurious-reg" class="section level1">
<h1>Plotting Spurious Reg</h1>
<div class="sourceCode" id="cb53"><pre
class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="do">### Bind up the results</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>res <span class="ot">=</span> <span class="fu">do.call</span>(rbind.data.frame, out)</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="do">### Load in plotting/cleaning packages</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a><span class="do">### Summarize data, pivot to long</span></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>sums <span class="ot">=</span> res <span class="sc">%&gt;%</span> </span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(n) <span class="sc">%&gt;%</span> </span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">size =</span> <span class="fu">mean</span>(<span class="fu">abs</span>(est<span class="sc">/</span>se) <span class="sc">&gt;</span> <span class="fu">qt</span>(.<span class="dv">975</span>, n <span class="sc">-</span> <span class="dv">2</span>)),</span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>            <span class="at">r2_avg =</span> <span class="fu">mean</span>(r2),</span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>            <span class="at">r2_med =</span> <span class="fu">median</span>(r2)) <span class="sc">%&gt;%</span></span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(size, r2_avg, r2_med))</span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a><span class="do">### Plot</span></span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> sums, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">factor</span>(name), <span class="at">y =</span> value, <span class="at">fill =</span> <span class="fu">factor</span>(n))) <span class="sc">+</span> </span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">position=</span><span class="st">&quot;dodge&quot;</span>, <span class="at">alpha=</span>.<span class="dv">6</span>) <span class="sc">+</span> </span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_d</span>(<span class="at">begin =</span> .<span class="dv">25</span>, </span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a>                       <span class="at">end =</span> .<span class="dv">75</span>, </span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a>                       <span class="at">name =</span> <span class="st">&quot;Sample Size&quot;</span></span>
<span id="cb53-26"><a href="#cb53-26" aria-hidden="true" tabindex="-1"></a>                       ) <span class="sc">+</span> </span>
<span id="cb53-27"><a href="#cb53-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">expression</span>(<span class="fu">paste</span>(<span class="st">&quot;Type I Error Rates (&quot;</span>, </span>
<span id="cb53-28"><a href="#cb53-28" aria-hidden="true" tabindex="-1"></a>                                alpha<span class="sc">==</span><span class="fl">0.05</span>,</span>
<span id="cb53-29"><a href="#cb53-29" aria-hidden="true" tabindex="-1"></a>                                <span class="st">&quot; test, two-tailed) and R-Squared in Spurious Regression&quot;</span>)),</span>
<span id="cb53-30"><a href="#cb53-30" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">&quot;Quantity&quot;</span>,</span>
<span id="cb53-31"><a href="#cb53-31" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;Value&quot;</span></span>
<span id="cb53-32"><a href="#cb53-32" aria-hidden="true" tabindex="-1"></a>       ) <span class="sc">+</span></span>
<span id="cb53-33"><a href="#cb53-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(<span class="at">labels =</span> <span class="fu">c</span>(<span class="fu">expression</span>(<span class="fu">paste</span>(R<span class="sc">^</span><span class="dv">2</span>, <span class="st">&quot; Avg.&quot;</span>)), </span>
<span id="cb53-34"><a href="#cb53-34" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">expression</span>(<span class="fu">paste</span>(R<span class="sc">^</span><span class="dv">2</span>, <span class="st">&quot; Med.&quot;</span>)), </span>
<span id="cb53-35"><a href="#cb53-35" aria-hidden="true" tabindex="-1"></a>                              <span class="st">&quot;Type I Rate&quot;</span>)</span>
<span id="cb53-36"><a href="#cb53-36" aria-hidden="true" tabindex="-1"></a>                   ) <span class="sc">+</span></span>
<span id="cb53-37"><a href="#cb53-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb53-38"><a href="#cb53-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face=</span><span class="st">&quot;bold&quot;</span>, <span class="at">size =</span> <span class="dv">17</span>),</span>
<span id="cb53-39"><a href="#cb53-39" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid.major.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb53-40"><a href="#cb53-40" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid.minor.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb53-41"><a href="#cb53-41" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">13</span>),</span>
<span id="cb53-42"><a href="#cb53-42" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">15</span>,<span class="at">face=</span><span class="st">&quot;bold&quot;</span>)</span>
<span id="cb53-43"><a href="#cb53-43" aria-hidden="true" tabindex="-1"></a>        ) </span></code></pre></div>
<p><img src="montes_files/figure-html/unnamed-chunk-29-1.png" width="888" /></p>
</div>
<div id="bias-of-ar1" class="section level1">
<h1>Bias of AR(1)</h1>
<div class="sourceCode" id="cb54"><pre
class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="do">### Install, load default packages (see `Helper Functions`)</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="fu">inst_load</span>()</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="do">### Define AR(1) Simulation function, with intercept</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>simulation_fn <span class="ot">=</span> <span class="cf">function</span>(grid_row){</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>  grid_row <span class="ot">=</span> <span class="fu">unlist</span>(grid_row)</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>  rho <span class="ot">=</span> grid_row[<span class="st">&quot;p&quot;</span>]</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>  y[[<span class="dv">1</span>]] <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="dv">1</span>)</span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>grid_row[<span class="st">&quot;n&quot;</span>]) {</span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>    y[[j]] <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="at">mean =</span> .<span class="dv">5</span> <span class="sc">+</span> rho<span class="sc">*</span>y[[j<span class="dv">-1</span>]])</span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(</span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>(</span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="fu">unlist</span>(y),</span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">lag_y =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="fu">head</span>(<span class="fu">unlist</span>(y), <span class="sc">-</span><span class="dv">1</span>)) <span class="co"># Base lag() function conflicts with dplyr namespace, safest to lag manually</span></span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb54-26"><a href="#cb54-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-27"><a href="#cb54-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-28"><a href="#cb54-28" aria-hidden="true" tabindex="-1"></a><span class="do">### Define estimation function</span></span>
<span id="cb54-29"><a href="#cb54-29" aria-hidden="true" tabindex="-1"></a>estimation_fn <span class="ot">=</span> <span class="cf">function</span>(dat, grid_row, iter_id){</span>
<span id="cb54-30"><a href="#cb54-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-31"><a href="#cb54-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-32"><a href="#cb54-32" aria-hidden="true" tabindex="-1"></a>  mod <span class="ot">=</span> <span class="fu">lm</span>(y <span class="sc">~</span> lag_y, <span class="at">data =</span> dat)</span>
<span id="cb54-33"><a href="#cb54-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-34"><a href="#cb54-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(</span>
<span id="cb54-35"><a href="#cb54-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>(<span class="at">iter_id =</span> iter_id, </span>
<span id="cb54-36"><a href="#cb54-36" aria-hidden="true" tabindex="-1"></a>               <span class="at">est =</span> <span class="fu">coef</span>(mod)[<span class="dv">2</span>], </span>
<span id="cb54-37"><a href="#cb54-37" aria-hidden="true" tabindex="-1"></a>               <span class="at">n =</span> grid_row[[<span class="st">&quot;n&quot;</span>]],</span>
<span id="cb54-38"><a href="#cb54-38" aria-hidden="true" tabindex="-1"></a>               <span class="at">p =</span> grid_row[[<span class="st">&quot;p&quot;</span>]]</span>
<span id="cb54-39"><a href="#cb54-39" aria-hidden="true" tabindex="-1"></a>               )</span>
<span id="cb54-40"><a href="#cb54-40" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb54-41"><a href="#cb54-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-42"><a href="#cb54-42" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb54-43"><a href="#cb54-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-44"><a href="#cb54-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-45"><a href="#cb54-45" aria-hidden="true" tabindex="-1"></a><span class="do">### Define grid</span></span>
<span id="cb54-46"><a href="#cb54-46" aria-hidden="true" tabindex="-1"></a>n <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">30</span>, <span class="dv">50</span>, <span class="dv">100</span>, <span class="dv">500</span>, <span class="dv">2500</span>)</span>
<span id="cb54-47"><a href="#cb54-47" aria-hidden="true" tabindex="-1"></a>p <span class="ot">=</span> <span class="fu">c</span>(.<span class="dv">2</span>, .<span class="dv">5</span>, .<span class="dv">75</span>, .<span class="dv">95</span>)</span>
<span id="cb54-48"><a href="#cb54-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-49"><a href="#cb54-49" aria-hidden="true" tabindex="-1"></a>nsims <span class="ot">=</span> <span class="dv">1000</span></span>
<span id="cb54-50"><a href="#cb54-50" aria-hidden="true" tabindex="-1"></a>grid <span class="ot">=</span> <span class="fu">expand.grid</span>(<span class="at">n =</span> n, </span>
<span id="cb54-51"><a href="#cb54-51" aria-hidden="true" tabindex="-1"></a>                   <span class="at">p =</span> p</span>
<span id="cb54-52"><a href="#cb54-52" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb54-53"><a href="#cb54-53" aria-hidden="true" tabindex="-1"></a>chunks <span class="ot">=</span> <span class="fu">seq</span>(<span class="at">from =</span> nsims, </span>
<span id="cb54-54"><a href="#cb54-54" aria-hidden="true" tabindex="-1"></a>             <span class="at">to =</span> nsims <span class="sc">*</span> <span class="fu">nrow</span>(grid), </span>
<span id="cb54-55"><a href="#cb54-55" aria-hidden="true" tabindex="-1"></a>             <span class="at">by =</span> nsims</span>
<span id="cb54-56"><a href="#cb54-56" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb54-57"><a href="#cb54-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-58"><a href="#cb54-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-59"><a href="#cb54-59" aria-hidden="true" tabindex="-1"></a><span class="do">### Simulate</span></span>
<span id="cb54-60"><a href="#cb54-60" aria-hidden="true" tabindex="-1"></a><span class="fu">setup_cl</span>()</span>
<span id="cb54-61"><a href="#cb54-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-62"><a href="#cb54-62" aria-hidden="true" tabindex="-1"></a>out <span class="ot">=</span> </span>
<span id="cb54-63"><a href="#cb54-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">foreach</span>(</span>
<span id="cb54-64"><a href="#cb54-64" aria-hidden="true" tabindex="-1"></a>  <span class="at">i =</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(grid)<span class="sc">*</span>nsims),</span>
<span id="cb54-65"><a href="#cb54-65" aria-hidden="true" tabindex="-1"></a>  <span class="at">.options.multicore =</span> <span class="fu">list</span>(<span class="at">preschedule=</span>T),</span>
<span id="cb54-66"><a href="#cb54-66" aria-hidden="true" tabindex="-1"></a>  <span class="at">.maxcombine =</span> <span class="fu">nrow</span>(grid)<span class="sc">*</span>nsims,</span>
<span id="cb54-67"><a href="#cb54-67" aria-hidden="true" tabindex="-1"></a>  <span class="at">.multicombine =</span> T,</span>
<span id="cb54-68"><a href="#cb54-68" aria-hidden="true" tabindex="-1"></a>  <span class="at">.packages =</span> <span class="st">&#39;RhpcBLASctl&#39;</span></span>
<span id="cb54-69"><a href="#cb54-69" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%dorng%</span> {</span>
<span id="cb54-70"><a href="#cb54-70" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-71"><a href="#cb54-71" aria-hidden="true" tabindex="-1"></a>  RhpcBLASctl<span class="sc">::</span><span class="fu">blas_set_num_threads</span>(<span class="dv">1</span>)</span>
<span id="cb54-72"><a href="#cb54-72" aria-hidden="true" tabindex="-1"></a>  RhpcBLASctl<span class="sc">::</span><span class="fu">omp_set_num_threads</span>(<span class="dv">1</span>)</span>
<span id="cb54-73"><a href="#cb54-73" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb54-74"><a href="#cb54-74" aria-hidden="true" tabindex="-1"></a>  grid_row <span class="ot">=</span> grid[<span class="fu">which.max</span>(i <span class="sc">&lt;=</span> chunks),]</span>
<span id="cb54-75"><a href="#cb54-75" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-76"><a href="#cb54-76" aria-hidden="true" tabindex="-1"></a>  dat <span class="ot">=</span> <span class="fu">simulation_fn</span>(grid_row)</span>
<span id="cb54-77"><a href="#cb54-77" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-78"><a href="#cb54-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">estimation_fn</span>(dat, grid_row, i))</span>
<span id="cb54-79"><a href="#cb54-79" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-80"><a href="#cb54-80" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb54-81"><a href="#cb54-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-82"><a href="#cb54-82" aria-hidden="true" tabindex="-1"></a><span class="fu">clear_cl</span>()</span></code></pre></div>
</div>
<div id="plotting-ar1-bias" class="section level1">
<h1>Plotting AR(1) Bias</h1>
<div class="sourceCode" id="cb55"><pre
class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="do">### Bind up results and summarize</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>res <span class="ot">=</span> <span class="fu">do.call</span>(rbind.data.frame, out)</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>sums <span class="ot">=</span> res <span class="sc">%&gt;%</span> </span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(n, p) <span class="sc">%&gt;%</span> </span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarize</span>(<span class="at">mean_lag =</span> <span class="fu">mean</span>(est)) <span class="sc">%&gt;%</span> </span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">bias =</span> <span class="dv">100</span><span class="sc">*</span>(mean_lag<span class="sc">/</span>p <span class="sc">-</span> <span class="dv">1</span>))</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a><span class="do">### Plot</span></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(sums, <span class="fu">aes</span>(<span class="at">y =</span> bias, <span class="at">x =</span> <span class="fu">factor</span>(p), <span class="at">fill =</span> <span class="fu">factor</span>(n))) <span class="sc">+</span>  </span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">position=</span><span class="st">&quot;dodge&quot;</span>, <span class="at">alpha =</span> .<span class="dv">6</span>) <span class="sc">+</span></span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_d</span>(<span class="at">begin =</span> .<span class="dv">2</span>, </span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>                       <span class="at">end =</span> .<span class="dv">8</span>, </span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>                       <span class="at">name =</span> <span class="st">&quot;Sample Size&quot;</span></span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a>                       ) <span class="sc">+</span></span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(<span class="at">position =</span> <span class="st">&quot;top&quot;</span>) <span class="sc">+</span></span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face=</span><span class="st">&quot;bold&quot;</span>, <span class="at">size =</span> <span class="dv">17</span>),</span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid.major.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid.minor.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb55-22"><a href="#cb55-22" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">13</span>),</span>
<span id="cb55-23"><a href="#cb55-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">15</span>,<span class="at">face=</span><span class="st">&quot;bold&quot;</span>)</span>
<span id="cb55-24"><a href="#cb55-24" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">+</span></span>
<span id="cb55-25"><a href="#cb55-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="fu">expression</span>(<span class="fu">paste</span>(<span class="st">&quot;True Autoregressive Parameter (&quot;</span>, rho, <span class="st">&quot;)&quot;</span>)),</span>
<span id="cb55-26"><a href="#cb55-26" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;% Bias&quot;</span>,</span>
<span id="cb55-27"><a href="#cb55-27" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">&quot;AR(1) Models are Downward Biased&quot;</span>)</span></code></pre></div>
<p><img src="montes_files/figure-html/unnamed-chunk-31-1.png" width="888" /></p>
</div>
<div id="heckman" class="section level1">
<h1>Heckman</h1>
<div class="sourceCode" id="cb56"><pre
class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="do">### Install and load necessary packages (see `Helper Functions`)</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="fu">inst_load</span>()</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a><span class="do">### FIML likelihood function</span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>fiml_ll <span class="ot">=</span> <span class="cf">function</span>(parms,  y, X, <span class="at">tau =</span> <span class="dv">0</span>){</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>  b <span class="ot">=</span> <span class="fu">head</span>(parms, <span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>  sig <span class="ot">=</span> <span class="fu">tail</span>(parms, <span class="dv">1</span>)</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>  obs <span class="ot">=</span>  y <span class="sc">&gt;</span> tau</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>  y_obs <span class="ot">=</span> y[obs]</span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>  y_cen <span class="ot">=</span> y[<span class="sc">!</span>obs]</span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>  eta <span class="ot">=</span> <span class="fu">as.vector</span>(X <span class="sc">%*%</span> b)</span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>  eta_obs <span class="ot">=</span> eta[obs]</span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>  eta_cen <span class="ot">=</span> eta[<span class="sc">!</span>obs]</span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a>  ll_uncens <span class="ot">=</span> <span class="fu">sum</span>(<span class="fu">dnorm</span>((y_obs <span class="sc">-</span> eta_obs)<span class="sc">/</span>sig, <span class="at">log=</span>T) <span class="sc">-</span> <span class="fu">log</span>(sig))</span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a>  ll_cens <span class="ot">=</span> <span class="fu">sum</span>(<span class="fu">pnorm</span>((tau <span class="sc">-</span> eta_cen)<span class="sc">/</span>sig, <span class="at">log.p =</span> T))</span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a>  ll <span class="ot">=</span> <span class="sc">-</span>(ll_uncens <span class="sc">+</span> ll_cens)</span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-24"><a href="#cb56-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(ll)</span>
<span id="cb56-25"><a href="#cb56-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-26"><a href="#cb56-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb56-27"><a href="#cb56-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-28"><a href="#cb56-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-29"><a href="#cb56-29" aria-hidden="true" tabindex="-1"></a><span class="do">### Define custom FIML regression function</span></span>
<span id="cb56-30"><a href="#cb56-30" aria-hidden="true" tabindex="-1"></a>fiml_reg <span class="ot">=</span> <span class="cf">function</span>(formula, data, ...){</span>
<span id="cb56-31"><a href="#cb56-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-32"><a href="#cb56-32" aria-hidden="true" tabindex="-1"></a>  fr <span class="ot">=</span> <span class="fu">model.frame</span>(formula, <span class="at">data =</span> data)</span>
<span id="cb56-33"><a href="#cb56-33" aria-hidden="true" tabindex="-1"></a>  X <span class="ot">=</span> <span class="fu">model.matrix</span>(formula, fr)</span>
<span id="cb56-34"><a href="#cb56-34" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">=</span> <span class="fu">model.response</span>(fr)</span>
<span id="cb56-35"><a href="#cb56-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-36"><a href="#cb56-36" aria-hidden="true" tabindex="-1"></a>  starts <span class="ot">=</span> <span class="fu">c</span>( </span>
<span id="cb56-37"><a href="#cb56-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coef</span>(<span class="fu">lm</span>(y <span class="sc">~</span> X <span class="sc">+</span> <span class="dv">0</span>)),</span>
<span id="cb56-38"><a href="#cb56-38" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span></span>
<span id="cb56-39"><a href="#cb56-39" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb56-40"><a href="#cb56-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-41"><a href="#cb56-41" aria-hidden="true" tabindex="-1"></a>  mod <span class="ot">=</span> <span class="fu">nlm</span>(fiml_ll, <span class="at">p =</span> starts, <span class="at">hessian =</span> T, <span class="at">X=</span>X, <span class="at">y =</span> y, ...)</span>
<span id="cb56-42"><a href="#cb56-42" aria-hidden="true" tabindex="-1"></a>  se <span class="ot">=</span> <span class="fu">sqrt</span>(<span class="fu">diag</span>(<span class="fu">solve</span>(mod<span class="sc">$</span>hessian)))</span>
<span id="cb56-43"><a href="#cb56-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-44"><a href="#cb56-44" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">=</span> <span class="fu">cbind.data.frame</span>(<span class="at">est =</span> mod<span class="sc">$</span>estimate, <span class="at">se =</span> se)</span>
<span id="cb56-45"><a href="#cb56-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(out)</span>
<span id="cb56-46"><a href="#cb56-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-47"><a href="#cb56-47" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb56-48"><a href="#cb56-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-49"><a href="#cb56-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-50"><a href="#cb56-50" aria-hidden="true" tabindex="-1"></a><span class="do">### Simulation function</span></span>
<span id="cb56-51"><a href="#cb56-51" aria-hidden="true" tabindex="-1"></a>simulation_fn <span class="ot">=</span> <span class="cf">function</span>(grid_row, b) {</span>
<span id="cb56-52"><a href="#cb56-52" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">=</span> grid_row[[<span class="st">&quot;n&quot;</span>]]</span>
<span id="cb56-53"><a href="#cb56-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-54"><a href="#cb56-54" aria-hidden="true" tabindex="-1"></a>  X <span class="ot">=</span> <span class="fu">cbind</span>(</span>
<span id="cb56-55"><a href="#cb56-55" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span>, </span>
<span id="cb56-56"><a href="#cb56-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rnorm</span>(n, <span class="at">sd =</span> <span class="fl">2.5</span>)</span>
<span id="cb56-57"><a href="#cb56-57" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb56-58"><a href="#cb56-58" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-59"><a href="#cb56-59" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">=</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> X<span class="sc">%*%</span>b, <span class="at">sd =</span> <span class="fl">1.75</span>)</span>
<span id="cb56-60"><a href="#cb56-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-61"><a href="#cb56-61" aria-hidden="true" tabindex="-1"></a>  obs <span class="ot">=</span>  <span class="fu">as.integer</span>(y <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb56-62"><a href="#cb56-62" aria-hidden="true" tabindex="-1"></a>  y[obs <span class="sc">==</span> <span class="dv">0</span>] <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb56-63"><a href="#cb56-63" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-64"><a href="#cb56-64" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">=</span> <span class="fu">cbind.data.frame</span>(</span>
<span id="cb56-65"><a href="#cb56-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">X =</span> X, </span>
<span id="cb56-66"><a href="#cb56-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> y, </span>
<span id="cb56-67"><a href="#cb56-67" aria-hidden="true" tabindex="-1"></a>    <span class="at">obs =</span> obs</span>
<span id="cb56-68"><a href="#cb56-68" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb56-69"><a href="#cb56-69" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-70"><a href="#cb56-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(out)</span>
<span id="cb56-71"><a href="#cb56-71" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-72"><a href="#cb56-72" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb56-73"><a href="#cb56-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-74"><a href="#cb56-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-75"><a href="#cb56-75" aria-hidden="true" tabindex="-1"></a><span class="do">### Estimation function</span></span>
<span id="cb56-76"><a href="#cb56-76" aria-hidden="true" tabindex="-1"></a>estimation_fn <span class="ot">=</span> <span class="cf">function</span>(dat, grid_row, iter, b){</span>
<span id="cb56-77"><a href="#cb56-77" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">=</span> grid_row[,<span class="st">&quot;n&quot;</span>]</span>
<span id="cb56-78"><a href="#cb56-78" aria-hidden="true" tabindex="-1"></a>  grid_row <span class="ot">=</span> <span class="fu">unname</span>(<span class="fu">unlist</span>(grid_row)) <span class="co"># to avoid naming conflicts later</span></span>
<span id="cb56-79"><a href="#cb56-79" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-80"><a href="#cb56-80" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-81"><a href="#cb56-81" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Model 1 - OLS</span></span>
<span id="cb56-82"><a href="#cb56-82" aria-hidden="true" tabindex="-1"></a>  ols <span class="ot">=</span> <span class="fu">lm</span>(y <span class="sc">~</span> X<span class="fl">.2</span>, <span class="at">data =</span> dat)</span>
<span id="cb56-83"><a href="#cb56-83" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-84"><a href="#cb56-84" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-85"><a href="#cb56-85" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Model 2 - Heckman</span></span>
<span id="cb56-86"><a href="#cb56-86" aria-hidden="true" tabindex="-1"></a>  hecksel <span class="ot">=</span> <span class="fu">suppressWarnings</span>(</span>
<span id="cb56-87"><a href="#cb56-87" aria-hidden="true" tabindex="-1"></a>    <span class="fu">glm</span>(</span>
<span id="cb56-88"><a href="#cb56-88" aria-hidden="true" tabindex="-1"></a>      obs <span class="sc">~</span> X<span class="fl">.2</span>,</span>
<span id="cb56-89"><a href="#cb56-89" aria-hidden="true" tabindex="-1"></a>      <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">&quot;probit&quot;</span>),</span>
<span id="cb56-90"><a href="#cb56-90" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> dat</span>
<span id="cb56-91"><a href="#cb56-91" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb56-92"><a href="#cb56-92" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb56-93"><a href="#cb56-93" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-94"><a href="#cb56-94" aria-hidden="true" tabindex="-1"></a>  eta <span class="ot">=</span> <span class="fu">predict</span>(hecksel)</span>
<span id="cb56-95"><a href="#cb56-95" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-96"><a href="#cb56-96" aria-hidden="true" tabindex="-1"></a>  imills <span class="ot">=</span> <span class="fu">dnorm</span>(eta)<span class="sc">/</span><span class="fu">pnorm</span>(eta)</span>
<span id="cb56-97"><a href="#cb56-97" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-98"><a href="#cb56-98" aria-hidden="true" tabindex="-1"></a>  heck2step <span class="ot">=</span> <span class="fu">lm</span>(y <span class="sc">~</span> X<span class="fl">.2</span> <span class="sc">+</span> imills,</span>
<span id="cb56-99"><a href="#cb56-99" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> dat,</span>
<span id="cb56-100"><a href="#cb56-100" aria-hidden="true" tabindex="-1"></a>                 <span class="at">subset =</span> obs <span class="sc">==</span> <span class="dv">1</span></span>
<span id="cb56-101"><a href="#cb56-101" aria-hidden="true" tabindex="-1"></a>                 )</span>
<span id="cb56-102"><a href="#cb56-102" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-103"><a href="#cb56-103" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-104"><a href="#cb56-104" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Model 3 - FIML Tobit 1</span></span>
<span id="cb56-105"><a href="#cb56-105" aria-hidden="true" tabindex="-1"></a>  out_fiml <span class="ot">=</span> <span class="fu">fiml_reg</span>(y <span class="sc">~</span> X<span class="fl">.2</span>, <span class="at">data =</span> dat, <span class="at">iterlim =</span> <span class="dv">5000</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>,]</span>
<span id="cb56-106"><a href="#cb56-106" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-107"><a href="#cb56-107" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-108"><a href="#cb56-108" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Proportion observed, tells how censored </span></span>
<span id="cb56-109"><a href="#cb56-109" aria-hidden="true" tabindex="-1"></a>  prop_obs <span class="ot">=</span> <span class="fu">sum</span>(dat<span class="sc">$</span>obs) <span class="sc">/</span> <span class="fu">nrow</span>(dat)</span>
<span id="cb56-110"><a href="#cb56-110" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-111"><a href="#cb56-111" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-112"><a href="#cb56-112" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Tidy everything for clean results</span></span>
<span id="cb56-113"><a href="#cb56-113" aria-hidden="true" tabindex="-1"></a>  out_2step <span class="ot">=</span> <span class="fu">summary</span>(heck2step)<span class="sc">$</span>coefficients[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb56-114"><a href="#cb56-114" aria-hidden="true" tabindex="-1"></a>  out_ols <span class="ot">=</span> <span class="fu">summary</span>(ols)<span class="sc">$</span>coefficients[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb56-115"><a href="#cb56-115" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-116"><a href="#cb56-116" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(out_2step) <span class="ot">=</span> <span class="fu">colnames</span>(out_ols) <span class="ot">=</span> <span class="fu">colnames</span>(out_fiml) <span class="ot">=</span>  <span class="fu">c</span>(<span class="st">&quot;est&quot;</span>, <span class="st">&quot;se&quot;</span>)</span>
<span id="cb56-117"><a href="#cb56-117" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(out_2step) <span class="ot">=</span> <span class="fu">rownames</span>(out_ols) <span class="ot">=</span> <span class="fu">rownames</span>(out_fiml) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;b1&quot;</span>, <span class="st">&quot;b2&quot;</span>)</span>
<span id="cb56-118"><a href="#cb56-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-119"><a href="#cb56-119" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">=</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&quot;ols&quot;</span>, <span class="st">&quot;2step&quot;</span>, <span class="st">&quot;fiml&quot;</span>), <span class="at">each =</span> <span class="fu">nrow</span>(out_2step))</span>
<span id="cb56-120"><a href="#cb56-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-121"><a href="#cb56-121" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">=</span> <span class="fu">cbind.data.frame</span>(</span>
<span id="cb56-122"><a href="#cb56-122" aria-hidden="true" tabindex="-1"></a>    <span class="at">model =</span> model,</span>
<span id="cb56-123"><a href="#cb56-123" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rbind.data.frame</span>(out_ols, out_2step, out_fiml)</span>
<span id="cb56-124"><a href="#cb56-124" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb56-125"><a href="#cb56-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-126"><a href="#cb56-126" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(out) <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb56-127"><a href="#cb56-127" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb56-128"><a href="#cb56-128" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb56-129"><a href="#cb56-129" aria-hidden="true" tabindex="-1"></a>    <span class="at">iter_id =</span> iter,</span>
<span id="cb56-130"><a href="#cb56-130" aria-hidden="true" tabindex="-1"></a>    <span class="at">param =</span> <span class="fu">rep</span>(<span class="fu">rownames</span>(out_2step), <span class="dv">3</span>),</span>
<span id="cb56-131"><a href="#cb56-131" aria-hidden="true" tabindex="-1"></a>    <span class="at">b1 =</span> <span class="fu">unname</span>(b[<span class="st">&quot;b1&quot;</span>]),</span>
<span id="cb56-132"><a href="#cb56-132" aria-hidden="true" tabindex="-1"></a>    <span class="at">b_tru =</span> <span class="fu">rep</span>(<span class="fu">unname</span>(b), <span class="dv">3</span>),</span>
<span id="cb56-133"><a href="#cb56-133" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> n,</span>
<span id="cb56-134"><a href="#cb56-134" aria-hidden="true" tabindex="-1"></a>    <span class="at">prop_obs =</span> prop_obs,</span>
<span id="cb56-135"><a href="#cb56-135" aria-hidden="true" tabindex="-1"></a>    out</span>
<span id="cb56-136"><a href="#cb56-136" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb56-137"><a href="#cb56-137" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-138"><a href="#cb56-138" aria-hidden="true" tabindex="-1"></a>} <span class="do">### End Estimation function</span></span>
<span id="cb56-139"><a href="#cb56-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-140"><a href="#cb56-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-141"><a href="#cb56-141" aria-hidden="true" tabindex="-1"></a><span class="do">### Set up for simulations</span></span>
<span id="cb56-142"><a href="#cb56-142" aria-hidden="true" tabindex="-1"></a>n <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">500</span>, <span class="dv">5000</span>)</span>
<span id="cb56-143"><a href="#cb56-143" aria-hidden="true" tabindex="-1"></a>b1 <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>)</span>
<span id="cb56-144"><a href="#cb56-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-145"><a href="#cb56-145" aria-hidden="true" tabindex="-1"></a>nsims <span class="ot">=</span> <span class="dv">1000</span></span>
<span id="cb56-146"><a href="#cb56-146" aria-hidden="true" tabindex="-1"></a>grid <span class="ot">=</span> <span class="fu">expand.grid</span>(<span class="at">n =</span> n, </span>
<span id="cb56-147"><a href="#cb56-147" aria-hidden="true" tabindex="-1"></a>                   <span class="at">b1 =</span> b1</span>
<span id="cb56-148"><a href="#cb56-148" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb56-149"><a href="#cb56-149" aria-hidden="true" tabindex="-1"></a>chunks <span class="ot">=</span> <span class="fu">seq</span>(<span class="at">from =</span> nsims, </span>
<span id="cb56-150"><a href="#cb56-150" aria-hidden="true" tabindex="-1"></a>             <span class="at">to =</span> nsims<span class="sc">*</span><span class="fu">nrow</span>(grid), </span>
<span id="cb56-151"><a href="#cb56-151" aria-hidden="true" tabindex="-1"></a>             <span class="at">by =</span> nsims</span>
<span id="cb56-152"><a href="#cb56-152" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb56-153"><a href="#cb56-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-154"><a href="#cb56-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-155"><a href="#cb56-155" aria-hidden="true" tabindex="-1"></a><span class="do">### Main simulations</span></span>
<span id="cb56-156"><a href="#cb56-156" aria-hidden="true" tabindex="-1"></a><span class="fu">setup_cl</span>()</span>
<span id="cb56-157"><a href="#cb56-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-158"><a href="#cb56-158" aria-hidden="true" tabindex="-1"></a>out <span class="ot">=</span> </span>
<span id="cb56-159"><a href="#cb56-159" aria-hidden="true" tabindex="-1"></a>  <span class="fu">foreach</span>(</span>
<span id="cb56-160"><a href="#cb56-160" aria-hidden="true" tabindex="-1"></a>  <span class="at">i =</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(grid)<span class="sc">*</span>nsims),</span>
<span id="cb56-161"><a href="#cb56-161" aria-hidden="true" tabindex="-1"></a>  <span class="at">.options.multicore =</span> <span class="fu">list</span>(<span class="at">preschedule=</span>T),</span>
<span id="cb56-162"><a href="#cb56-162" aria-hidden="true" tabindex="-1"></a>  <span class="at">.maxcombine =</span> <span class="fu">nrow</span>(grid)<span class="sc">*</span>nsims,</span>
<span id="cb56-163"><a href="#cb56-163" aria-hidden="true" tabindex="-1"></a>  <span class="at">.multicombine =</span> T,</span>
<span id="cb56-164"><a href="#cb56-164" aria-hidden="true" tabindex="-1"></a>  <span class="at">.packages =</span> <span class="fu">c</span>(<span class="st">&#39;RhpcBLASctl&#39;</span>)</span>
<span id="cb56-165"><a href="#cb56-165" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%dorng%</span> {</span>
<span id="cb56-166"><a href="#cb56-166" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-167"><a href="#cb56-167" aria-hidden="true" tabindex="-1"></a>  RhpcBLASctl<span class="sc">::</span><span class="fu">blas_set_num_threads</span>(<span class="dv">1</span>)</span>
<span id="cb56-168"><a href="#cb56-168" aria-hidden="true" tabindex="-1"></a>  RhpcBLASctl<span class="sc">::</span><span class="fu">omp_set_num_threads</span>(<span class="dv">1</span>)</span>
<span id="cb56-169"><a href="#cb56-169" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb56-170"><a href="#cb56-170" aria-hidden="true" tabindex="-1"></a>  grid_row <span class="ot">=</span> grid[<span class="fu">which.max</span>(i <span class="sc">&lt;=</span> chunks),]</span>
<span id="cb56-171"><a href="#cb56-171" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-172"><a href="#cb56-172" aria-hidden="true" tabindex="-1"></a>  b1 <span class="ot">=</span> grid_row[[<span class="st">&quot;b1&quot;</span>]]</span>
<span id="cb56-173"><a href="#cb56-173" aria-hidden="true" tabindex="-1"></a>  b <span class="ot">=</span> <span class="fu">c</span>(<span class="at">b1 =</span> b1, <span class="at">b2 =</span> <span class="sc">-</span><span class="fl">1.75</span>)</span>
<span id="cb56-174"><a href="#cb56-174" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-175"><a href="#cb56-175" aria-hidden="true" tabindex="-1"></a>  dat <span class="ot">=</span> <span class="fu">simulation_fn</span>(grid_row, b)</span>
<span id="cb56-176"><a href="#cb56-176" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-177"><a href="#cb56-177" aria-hidden="true" tabindex="-1"></a>  <span class="fu">estimation_fn</span>(dat, grid_row, i, b)</span>
<span id="cb56-178"><a href="#cb56-178" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-179"><a href="#cb56-179" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb56-180"><a href="#cb56-180" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-181"><a href="#cb56-181" aria-hidden="true" tabindex="-1"></a><span class="fu">clear_cl</span>()</span></code></pre></div>
</div>
<div id="plotting-selection-mods" class="section level1">
<h1>Plotting Selection Mods</h1>
<div class="sourceCode" id="cb57"><pre
class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="do">### Bind up the results list into a data.frame</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>res <span class="ot">=</span> <span class="fu">do.call</span>(rbind.data.frame, out)</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a><span class="do">### Summarize the data for plotting</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>sums <span class="ot">=</span> res <span class="sc">%&gt;%</span> </span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(b1) <span class="sc">%&gt;%</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">avg_obs =</span> <span class="fu">round</span>(<span class="fu">mean</span>(prop_obs),<span class="dv">2</span>),</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>                <span class="at">est_c =</span> <span class="dv">100</span><span class="sc">*</span>(est <span class="sc">-</span> b_tru)<span class="sc">/</span>b_tru</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a><span class="do">### Re-order brewer color palette so that green is the &quot;best&quot; model in plots</span></span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>clrs <span class="ot">=</span> RColorBrewer<span class="sc">::</span><span class="fu">brewer.pal</span>(<span class="dv">3</span>, <span class="st">&quot;Set1&quot;</span>)[<span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">1</span>)]</span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a><span class="do">### Plot Intercept, showing upward bias</span></span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(sums[sums<span class="sc">$</span>param <span class="sc">==</span> <span class="st">&quot;b1&quot;</span>,], <span class="fu">aes</span>(<span class="at">x =</span> est_c, <span class="at">fill =</span> model, <span class="at">color =</span> model)) <span class="sc">+</span> </span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">trim =</span> T, <span class="at">alpha =</span> .<span class="dv">25</span>, <span class="at">bw =</span> <span class="st">&quot;SJ&quot;</span>) <span class="sc">+</span></span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">labels =</span>  <span class="fu">c</span>(<span class="st">&quot;2-Step&quot;</span>, <span class="st">&quot;FIML&quot;</span>, <span class="st">&quot;OLS&quot;</span>),</span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>                    <span class="at">values =</span> clrs) <span class="sc">+</span></span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">labels =</span>  <span class="fu">c</span>(<span class="st">&quot;2-Step&quot;</span>, <span class="st">&quot;FIML&quot;</span>, <span class="st">&quot;OLS&quot;</span>),</span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a>                     <span class="at">values =</span> clrs) <span class="sc">+</span></span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">lty =</span> <span class="st">&quot;dashed&quot;</span>) <span class="sc">+</span></span>
<span id="cb57-23"><a href="#cb57-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(avg_obs <span class="sc">~</span> n,</span>
<span id="cb57-24"><a href="#cb57-24" aria-hidden="true" tabindex="-1"></a>             <span class="at">labeller =</span> <span class="fu">label_bquote</span>(</span>
<span id="cb57-25"><a href="#cb57-25" aria-hidden="true" tabindex="-1"></a>               <span class="at">rows =</span> <span class="st">&quot;Prop. Observed&quot;</span> <span class="sc">==</span> .(avg_obs),</span>
<span id="cb57-26"><a href="#cb57-26" aria-hidden="true" tabindex="-1"></a>               <span class="at">cols =</span> <span class="st">&quot;n&quot;</span> <span class="sc">==</span> .(n)</span>
<span id="cb57-27"><a href="#cb57-27" aria-hidden="true" tabindex="-1"></a>              )) <span class="sc">+</span> </span>
<span id="cb57-28"><a href="#cb57-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">35</span>, <span class="dv">150</span>)) <span class="sc">+</span></span>
<span id="cb57-29"><a href="#cb57-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>( <span class="at">x =</span> <span class="fu">expression</span>(<span class="fu">paste</span>(<span class="st">&quot;% Difference  (&quot;</span>, <span class="fu">hat</span>(beta)<span class="sc">-</span>beta,<span class="st">&quot;)/&quot;</span>, beta)),</span>
<span id="cb57-30"><a href="#cb57-30" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">&quot;Kernel Density Estimate&quot;</span>,</span>
<span id="cb57-31"><a href="#cb57-31" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="st">&quot;The Intercept is Biased Upwards Under Censoring, and 2-Step is Inefficient&quot;</span> ) <span class="sc">+</span></span>
<span id="cb57-32"><a href="#cb57-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb57-33"><a href="#cb57-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face=</span><span class="st">&quot;bold&quot;</span>, <span class="at">size =</span> <span class="dv">17</span>),</span>
<span id="cb57-34"><a href="#cb57-34" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">13</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>),</span>
<span id="cb57-35"><a href="#cb57-35" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">15</span>,<span class="at">face=</span><span class="st">&quot;bold&quot;</span>),</span>
<span id="cb57-36"><a href="#cb57-36" aria-hidden="true" tabindex="-1"></a>        <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb57-37"><a href="#cb57-37" aria-hidden="true" tabindex="-1"></a>        ) </span></code></pre></div>
<p><img src="montes_files/figure-html/unnamed-chunk-33-1.png" width="960" /></p>
<div class="sourceCode" id="cb58"><pre
class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="do">### Plot slope, showing downward bias</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(sums[sums<span class="sc">$</span>param <span class="sc">==</span> <span class="st">&quot;b2&quot;</span>,], <span class="fu">aes</span>(<span class="at">x =</span> est_c, <span class="at">fill =</span> model, <span class="at">color =</span> model)) <span class="sc">+</span> </span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">trim =</span> T, <span class="at">alpha =</span> .<span class="dv">25</span>, <span class="at">bw =</span> <span class="st">&quot;SJ&quot;</span>) <span class="sc">+</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">labels =</span>  <span class="fu">c</span>(<span class="st">&quot;2-Step&quot;</span>, <span class="st">&quot;FIML&quot;</span>, <span class="st">&quot;OLS&quot;</span>),</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>                    <span class="at">values =</span> clrs) <span class="sc">+</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">labels =</span>  <span class="fu">c</span>(<span class="st">&quot;2-Step&quot;</span>, <span class="st">&quot;FIML&quot;</span>, <span class="st">&quot;OLS&quot;</span>),</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>                     <span class="at">values =</span> clrs) <span class="sc">+</span></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">lty =</span> <span class="st">&quot;dashed&quot;</span>) <span class="sc">+</span></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(avg_obs <span class="sc">~</span> n,</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>             <span class="at">labeller =</span> <span class="fu">label_bquote</span>(</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>               <span class="at">rows =</span> <span class="st">&quot;Prop. Observed&quot;</span> <span class="sc">==</span> .(avg_obs),</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>               <span class="at">cols =</span> <span class="st">&quot;n&quot;</span> <span class="sc">==</span> .(n)</span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>              )) <span class="sc">+</span> </span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">60</span>, <span class="dv">15</span>)) <span class="sc">+</span></span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>( <span class="at">x =</span> <span class="fu">expression</span>(<span class="fu">paste</span>(<span class="st">&quot;% Difference  (&quot;</span>, <span class="fu">hat</span>(beta)<span class="sc">-</span>beta,<span class="st">&quot;)/&quot;</span>, beta)),</span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">&quot;Kernel Density Estimate&quot;</span>,</span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="st">&quot;The Slope is Biased Downwards Under Censoring, and 2-Step is Inefficient&quot;</span> ) <span class="sc">+</span></span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face=</span><span class="st">&quot;bold&quot;</span>, <span class="at">size =</span> <span class="dv">17</span>),</span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">13</span>, <span class="at">face=</span><span class="st">&quot;bold&quot;</span>),</span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">15</span>,<span class="at">face=</span><span class="st">&quot;bold&quot;</span>),</span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true" tabindex="-1"></a>        <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb58-23"><a href="#cb58-23" aria-hidden="true" tabindex="-1"></a>        ) </span></code></pre></div>
<p><img src="montes_files/figure-html/unnamed-chunk-33-2.png" width="960" /></p>
</div>
<div id="logit-bias" class="section level1">
<h1>Logit Bias</h1>
<div class="sourceCode" id="cb59"><pre
class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="do">### Install, load necessary packages (see `Helper Functions`)</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="fu">inst_load</span>(<span class="at">pks =</span> <span class="st">&#39;brglm2&#39;</span>)</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a><span class="do">### Define Simulation function</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>simulation_fn <span class="ot">=</span> <span class="cf">function</span>(grid_row){</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>  b1 <span class="ot">=</span> grid_row[[<span class="st">&quot;b1&quot;</span>]]</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">=</span> grid_row[[<span class="st">&quot;n&quot;</span>]]</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>  btrue <span class="ot">=</span> grid_row[[<span class="st">&quot;btrue&quot;</span>]]</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>  X <span class="ot">=</span> <span class="fu">cbind</span>(</span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span>,</span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rexp</span>(n, .<span class="dv">25</span>),</span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">matrix</span>(<span class="fu">rnorm</span>(n <span class="sc">*</span> <span class="dv">4</span>), <span class="at">ncol=</span><span class="dv">4</span>)</span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a>  b <span class="ot">=</span> <span class="fu">c</span>(b1, btrue, <span class="fl">1.75</span>, <span class="sc">-</span>.<span class="dv">25</span>, .<span class="dv">5</span>, <span class="sc">-</span><span class="fl">2.33</span>)</span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a>  eta <span class="ot">=</span> X<span class="sc">%*%</span>b</span>
<span id="cb59-19"><a href="#cb59-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-20"><a href="#cb59-20" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">=</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(eta))</span>
<span id="cb59-21"><a href="#cb59-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-22"><a href="#cb59-22" aria-hidden="true" tabindex="-1"></a>  dat <span class="ot">=</span> <span class="fu">cbind.data.frame</span>(<span class="at">y =</span> y, <span class="at">X =</span> X[,<span class="sc">-</span><span class="dv">1</span>])</span>
<span id="cb59-23"><a href="#cb59-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-24"><a href="#cb59-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(dat)</span>
<span id="cb59-25"><a href="#cb59-25" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb59-26"><a href="#cb59-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-27"><a href="#cb59-27" aria-hidden="true" tabindex="-1"></a><span class="do">### Define Estimation Function</span></span>
<span id="cb59-28"><a href="#cb59-28" aria-hidden="true" tabindex="-1"></a>estimation_fn <span class="ot">=</span> <span class="cf">function</span>(data, grid_row, iter_id){</span>
<span id="cb59-29"><a href="#cb59-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-30"><a href="#cb59-30" aria-hidden="true" tabindex="-1"></a>  grid_row <span class="ot">=</span> <span class="fu">unlist</span>(grid_row)</span>
<span id="cb59-31"><a href="#cb59-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-32"><a href="#cb59-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Model 1 - ML logit, filter out perfect prediction/non-convergence </span></span>
<span id="cb59-33"><a href="#cb59-33" aria-hidden="true" tabindex="-1"></a>  mod_bad <span class="ot">=</span> <span class="fu">tryCatch</span>(</span>
<span id="cb59-34"><a href="#cb59-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">glm</span>(y <span class="sc">~</span> . , </span>
<span id="cb59-35"><a href="#cb59-35" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> dat, </span>
<span id="cb59-36"><a href="#cb59-36" aria-hidden="true" tabindex="-1"></a>        <span class="at">family=</span><span class="fu">binomial</span>(<span class="at">link=</span><span class="st">&quot;logit&quot;</span>)</span>
<span id="cb59-37"><a href="#cb59-37" aria-hidden="true" tabindex="-1"></a>      ), </span>
<span id="cb59-38"><a href="#cb59-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">warning =</span> <span class="cf">function</span>(w) <span class="cf">if</span>(<span class="fu">grepl</span>(<span class="st">&quot;fitted probabilities || not converge&quot;</span>, w<span class="sc">$</span>message)) <span class="fu">return</span>(<span class="cn">NULL</span>) <span class="cf">else</span> <span class="fu">warning</span>(w<span class="sc">$</span>message)</span>
<span id="cb59-39"><a href="#cb59-39" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb59-40"><a href="#cb59-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-41"><a href="#cb59-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-42"><a href="#cb59-42" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(mod_bad))</span>
<span id="cb59-43"><a href="#cb59-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb59-44"><a href="#cb59-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-45"><a href="#cb59-45" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Model 2 - PML &quot;Firth&quot; Logit</span></span>
<span id="cb59-46"><a href="#cb59-46" aria-hidden="true" tabindex="-1"></a>  mod_good <span class="ot">=</span> <span class="fu">glm</span>(y <span class="sc">~</span> . , </span>
<span id="cb59-47"><a href="#cb59-47" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> dat,</span>
<span id="cb59-48"><a href="#cb59-48" aria-hidden="true" tabindex="-1"></a>                 <span class="at">method =</span> <span class="st">&quot;brglmFit&quot;</span>,</span>
<span id="cb59-49"><a href="#cb59-49" aria-hidden="true" tabindex="-1"></a>                 <span class="at">type =</span> <span class="st">&#39;AS_mean&#39;</span>,</span>
<span id="cb59-50"><a href="#cb59-50" aria-hidden="true" tabindex="-1"></a>                 <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">&quot;logit&quot;</span>)</span>
<span id="cb59-51"><a href="#cb59-51" aria-hidden="true" tabindex="-1"></a>              )</span>
<span id="cb59-52"><a href="#cb59-52" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-53"><a href="#cb59-53" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get proportion of successes in model</span></span>
<span id="cb59-54"><a href="#cb59-54" aria-hidden="true" tabindex="-1"></a>  success <span class="ot">=</span> <span class="fu">mean</span>(dat<span class="sc">$</span>y)</span>
<span id="cb59-55"><a href="#cb59-55" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-56"><a href="#cb59-56" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get coefs</span></span>
<span id="cb59-57"><a href="#cb59-57" aria-hidden="true" tabindex="-1"></a>  out_bad <span class="ot">=</span> <span class="fu">summary</span>(mod_bad)<span class="sc">$</span>coefficients[<span class="dv">2</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb59-58"><a href="#cb59-58" aria-hidden="true" tabindex="-1"></a>  out_good <span class="ot">=</span> <span class="fu">summary</span>(mod_good)<span class="sc">$</span>coefficients[<span class="dv">2</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb59-59"><a href="#cb59-59" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-60"><a href="#cb59-60" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">=</span> <span class="fu">rbind</span>(out_bad, out_good)</span>
<span id="cb59-61"><a href="#cb59-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(out) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;est&quot;</span>, <span class="st">&quot;se&quot;</span>)</span>
<span id="cb59-62"><a href="#cb59-62" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-63"><a href="#cb59-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cbind.data.frame</span>(</span>
<span id="cb59-64"><a href="#cb59-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">iter_id =</span> iter_id,</span>
<span id="cb59-65"><a href="#cb59-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> grid_row[[<span class="st">&quot;n&quot;</span>]],</span>
<span id="cb59-66"><a href="#cb59-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">b1 =</span> grid_row[[<span class="st">&quot;b1&quot;</span>]],</span>
<span id="cb59-67"><a href="#cb59-67" aria-hidden="true" tabindex="-1"></a>    <span class="at">success =</span> success,</span>
<span id="cb59-68"><a href="#cb59-68" aria-hidden="true" tabindex="-1"></a>    <span class="at">btrue =</span> grid_row[[<span class="st">&quot;btrue&quot;</span>]],</span>
<span id="cb59-69"><a href="#cb59-69" aria-hidden="true" tabindex="-1"></a>    <span class="at">model =</span> <span class="fu">c</span>(<span class="st">&quot;ML&quot;</span>, <span class="st">&quot;PML&quot;</span>),</span>
<span id="cb59-70"><a href="#cb59-70" aria-hidden="true" tabindex="-1"></a>    out</span>
<span id="cb59-71"><a href="#cb59-71" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb59-72"><a href="#cb59-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-73"><a href="#cb59-73" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb59-74"><a href="#cb59-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-75"><a href="#cb59-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-76"><a href="#cb59-76" aria-hidden="true" tabindex="-1"></a><span class="do">### Set up Simulations</span></span>
<span id="cb59-77"><a href="#cb59-77" aria-hidden="true" tabindex="-1"></a>nsims <span class="ot">=</span> <span class="dv">1000</span></span>
<span id="cb59-78"><a href="#cb59-78" aria-hidden="true" tabindex="-1"></a>b1 <span class="ot">=</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">5</span></span>
<span id="cb59-79"><a href="#cb59-79" aria-hidden="true" tabindex="-1"></a>n <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">100</span>, <span class="dv">150</span>, <span class="dv">200</span>, <span class="dv">500</span>)</span>
<span id="cb59-80"><a href="#cb59-80" aria-hidden="true" tabindex="-1"></a>grid <span class="ot">=</span> <span class="fu">expand.grid</span>(<span class="at">b1 =</span> b1, </span>
<span id="cb59-81"><a href="#cb59-81" aria-hidden="true" tabindex="-1"></a>                   <span class="at">n =</span> n</span>
<span id="cb59-82"><a href="#cb59-82" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb59-83"><a href="#cb59-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-84"><a href="#cb59-84" aria-hidden="true" tabindex="-1"></a><span class="co"># True Slope coefficient (invariant)</span></span>
<span id="cb59-85"><a href="#cb59-85" aria-hidden="true" tabindex="-1"></a>grid<span class="sc">$</span>btrue <span class="ot">=</span> <span class="sc">-</span>.<span class="dv">75</span></span>
<span id="cb59-86"><a href="#cb59-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-87"><a href="#cb59-87" aria-hidden="true" tabindex="-1"></a>chunks <span class="ot">=</span> <span class="fu">seq</span>(<span class="at">from =</span> nsims, </span>
<span id="cb59-88"><a href="#cb59-88" aria-hidden="true" tabindex="-1"></a>             <span class="at">to =</span> nsims<span class="sc">*</span><span class="fu">nrow</span>(grid), </span>
<span id="cb59-89"><a href="#cb59-89" aria-hidden="true" tabindex="-1"></a>             <span class="at">by =</span> nsims</span>
<span id="cb59-90"><a href="#cb59-90" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb59-91"><a href="#cb59-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-92"><a href="#cb59-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-93"><a href="#cb59-93" aria-hidden="true" tabindex="-1"></a><span class="do">### Do simulations</span></span>
<span id="cb59-94"><a href="#cb59-94" aria-hidden="true" tabindex="-1"></a><span class="fu">setup_cl</span>()</span>
<span id="cb59-95"><a href="#cb59-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-96"><a href="#cb59-96" aria-hidden="true" tabindex="-1"></a>out <span class="ot">=</span> </span>
<span id="cb59-97"><a href="#cb59-97" aria-hidden="true" tabindex="-1"></a>  <span class="fu">foreach</span>(</span>
<span id="cb59-98"><a href="#cb59-98" aria-hidden="true" tabindex="-1"></a>    <span class="at">i =</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(grid)<span class="sc">*</span>nsims),</span>
<span id="cb59-99"><a href="#cb59-99" aria-hidden="true" tabindex="-1"></a>    <span class="at">.options.multicore =</span> <span class="fu">list</span>(<span class="at">preschedule=</span>T),</span>
<span id="cb59-100"><a href="#cb59-100" aria-hidden="true" tabindex="-1"></a>    <span class="at">.maxcombine =</span> <span class="fu">nrow</span>(grid)<span class="sc">*</span>nsims,</span>
<span id="cb59-101"><a href="#cb59-101" aria-hidden="true" tabindex="-1"></a>    <span class="at">.multicombine =</span> T,</span>
<span id="cb59-102"><a href="#cb59-102" aria-hidden="true" tabindex="-1"></a>    <span class="at">.packages =</span> <span class="fu">c</span>(<span class="st">&#39;RhpcBLASctl&#39;</span>, <span class="st">&#39;brglm2&#39;</span>)</span>
<span id="cb59-103"><a href="#cb59-103" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%dorng%</span> {</span>
<span id="cb59-104"><a href="#cb59-104" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-105"><a href="#cb59-105" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-106"><a href="#cb59-106" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(brglm2)</span>
<span id="cb59-107"><a href="#cb59-107" aria-hidden="true" tabindex="-1"></a>  RhpcBLASctl<span class="sc">::</span><span class="fu">blas_set_num_threads</span>(<span class="dv">1</span>)</span>
<span id="cb59-108"><a href="#cb59-108" aria-hidden="true" tabindex="-1"></a>  RhpcBLASctl<span class="sc">::</span><span class="fu">omp_set_num_threads</span>(<span class="dv">1</span>)</span>
<span id="cb59-109"><a href="#cb59-109" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb59-110"><a href="#cb59-110" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(i <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> i <span class="sc">&lt;=</span> <span class="fu">tail</span>(chunks, <span class="dv">1</span>))</span>
<span id="cb59-111"><a href="#cb59-111" aria-hidden="true" tabindex="-1"></a>  grid_row <span class="ot">=</span> grid[<span class="fu">which.max</span>(i <span class="sc">&lt;=</span> chunks),]</span>
<span id="cb59-112"><a href="#cb59-112" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-113"><a href="#cb59-113" aria-hidden="true" tabindex="-1"></a>  dat <span class="ot">=</span> <span class="fu">simulation_fn</span>(grid_row)</span>
<span id="cb59-114"><a href="#cb59-114" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>(dat)</span>
<span id="cb59-115"><a href="#cb59-115" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-116"><a href="#cb59-116" aria-hidden="true" tabindex="-1"></a>  <span class="fu">estimation_fn</span>(dat, grid_row, i)</span>
<span id="cb59-117"><a href="#cb59-117" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-118"><a href="#cb59-118" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb59-119"><a href="#cb59-119" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-120"><a href="#cb59-120" aria-hidden="true" tabindex="-1"></a><span class="fu">clear_cl</span>()</span></code></pre></div>
</div>
<div id="plotting-logit-bias" class="section level1">
<h1>plotting logit bias</h1>
<div class="sourceCode" id="cb60"><pre
class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="do">### Bind everything up</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>res <span class="ot">=</span> <span class="fu">do.call</span>(rbind.data.frame, out)</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a><span class="do">### Add in percent difference (est_c) and compute average success rate (affected by intercept)</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>res<span class="sc">$</span>est_c <span class="ot">=</span> <span class="dv">100</span><span class="sc">*</span>(res<span class="sc">$</span>est <span class="sc">-</span> res<span class="sc">$</span>btrue)<span class="sc">/</span>res<span class="sc">$</span>btrue</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>res <span class="ot">=</span> res <span class="sc">%&gt;%</span> </span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(b1) <span class="sc">%&gt;%</span> </span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">success =</span> <span class="fu">round</span>(<span class="fu">mean</span>(success), <span class="dv">2</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(n, b1, btrue, model) <span class="sc">%&gt;%</span></span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">avg =</span> <span class="fu">mean</span>(est_c))</span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a><span class="do">### Group level summaries for bar plots</span></span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a>sums <span class="ot">=</span> res <span class="sc">%&gt;%</span></span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(b1) <span class="sc">%&gt;%</span> </span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">success =</span> <span class="fu">round</span>(<span class="fu">mean</span>(success), <span class="dv">2</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(n, success, btrue, model) <span class="sc">%&gt;%</span></span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">reject =</span> <span class="fu">abs</span>(est<span class="sc">/</span>se) <span class="sc">&gt;</span> <span class="fu">qnorm</span>(.<span class="dv">975</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb60-20"><a href="#cb60-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">avg =</span> <span class="fu">mean</span>(est),</span>
<span id="cb60-21"><a href="#cb60-21" aria-hidden="true" tabindex="-1"></a>            <span class="at">power =</span> <span class="fu">mean</span>(reject)) <span class="sc">%&gt;%</span> </span>
<span id="cb60-22"><a href="#cb60-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">bias =</span> <span class="dv">100</span><span class="sc">*</span>(avg <span class="sc">-</span> btrue)<span class="sc">/</span>btrue)</span>
<span id="cb60-23"><a href="#cb60-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-24"><a href="#cb60-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-25"><a href="#cb60-25" aria-hidden="true" tabindex="-1"></a><span class="do">### Density Plots</span></span>
<span id="cb60-26"><a href="#cb60-26" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(res, <span class="fu">aes</span>(<span class="at">x =</span> est_c, <span class="at">fill =</span> model, <span class="at">color =</span> model)) <span class="sc">+</span></span>
<span id="cb60-27"><a href="#cb60-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">trim =</span> T, <span class="at">alpha =</span> .<span class="dv">15</span>, <span class="at">bw =</span> <span class="st">&quot;SJ&quot;</span>) <span class="sc">+</span></span>
<span id="cb60-28"><a href="#cb60-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">&quot;Set1&quot;</span>) <span class="sc">+</span></span>
<span id="cb60-29"><a href="#cb60-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_brewer</span>(<span class="at">palette =</span> <span class="st">&#39;Set1&#39;</span>) <span class="sc">+</span></span>
<span id="cb60-30"><a href="#cb60-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(success <span class="sc">~</span> n,</span>
<span id="cb60-31"><a href="#cb60-31" aria-hidden="true" tabindex="-1"></a>             <span class="at">labeller =</span> <span class="fu">label_bquote</span>(</span>
<span id="cb60-32"><a href="#cb60-32" aria-hidden="true" tabindex="-1"></a>               <span class="at">rows =</span> <span class="st">&quot;Prop. Success&quot;</span> <span class="sc">==</span> .(success),</span>
<span id="cb60-33"><a href="#cb60-33" aria-hidden="true" tabindex="-1"></a>               <span class="at">cols =</span> <span class="st">&quot;n&quot;</span> <span class="sc">==</span> .(n)</span>
<span id="cb60-34"><a href="#cb60-34" aria-hidden="true" tabindex="-1"></a>              )) <span class="sc">+</span> </span>
<span id="cb60-35"><a href="#cb60-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">100</span>, <span class="dv">150</span>)) <span class="sc">+</span></span>
<span id="cb60-36"><a href="#cb60-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">data =</span> res, </span>
<span id="cb60-37"><a href="#cb60-37" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">xintercept =</span> avg, <span class="at">color =</span> model), </span>
<span id="cb60-38"><a href="#cb60-38" aria-hidden="true" tabindex="-1"></a>             <span class="at">lty =</span> <span class="st">&quot;dashed&quot;</span>) <span class="sc">+</span> </span>
<span id="cb60-39"><a href="#cb60-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">lty =</span> <span class="st">&#39;dotted&#39;</span>) <span class="sc">+</span> </span>
<span id="cb60-40"><a href="#cb60-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb60-41"><a href="#cb60-41" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="fu">expression</span>(<span class="fu">paste</span>(<span class="st">&quot;% Difference  (&quot;</span>, <span class="fu">hat</span>(beta)<span class="sc">-</span>beta,<span class="st">&quot;)/&quot;</span>, beta)),</span>
<span id="cb60-42"><a href="#cb60-42" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">&quot;Kernel Density Estimate&quot;</span>,</span>
<span id="cb60-43"><a href="#cb60-43" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">&quot;PML Models are Less Biased, More Efficient than ML Logit Models with small N&quot;</span></span>
<span id="cb60-44"><a href="#cb60-44" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb60-45"><a href="#cb60-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb60-46"><a href="#cb60-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face=</span><span class="st">&quot;bold&quot;</span>, <span class="at">size =</span> <span class="dv">17</span>),</span>
<span id="cb60-47"><a href="#cb60-47" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">10</span>),</span>
<span id="cb60-48"><a href="#cb60-48" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">15</span>,<span class="at">face=</span><span class="st">&quot;bold&quot;</span>),</span>
<span id="cb60-49"><a href="#cb60-49" aria-hidden="true" tabindex="-1"></a>        <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb60-50"><a href="#cb60-50" aria-hidden="true" tabindex="-1"></a>        ) </span></code></pre></div>
<p><img src="montes_files/figure-html/unnamed-chunk-35-1.png" width="960" /></p>
<div class="sourceCode" id="cb61"><pre
class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="do">### Barplot for Bias</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(sums, <span class="fu">aes</span>(<span class="at">y =</span> bias, <span class="at">x =</span> <span class="fu">factor</span>(model), <span class="at">fill =</span> <span class="fu">factor</span>(n))) <span class="sc">+</span>  </span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">position=</span><span class="st">&quot;dodge&quot;</span>, <span class="at">alpha =</span> .<span class="dv">6</span>) <span class="sc">+</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_d</span>(<span class="at">begin =</span> .<span class="dv">2</span>, </span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">end =</span> .<span class="dv">8</span>, </span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>                       <span class="at">name =</span> <span class="st">&quot;Sample Size&quot;</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>                       ) <span class="sc">+</span></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(success),</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>             <span class="at">labeller =</span> <span class="fu">label_bquote</span>(<span class="st">&quot;Prop. Success&quot;</span> <span class="sc">==</span> .(success))) <span class="sc">+</span></span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;Model&quot;</span>,</span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&quot;% Bias&quot;</span>,</span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&quot;PML Logit Models are Less Biased than ML Logit Models&quot;</span></span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face=</span><span class="st">&quot;bold&quot;</span>, <span class="at">size =</span> <span class="dv">17</span>),</span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid.major.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid.minor.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">13</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>),</span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">15</span>,<span class="at">face=</span><span class="st">&quot;bold&quot;</span>),</span>
<span id="cb61-21"><a href="#cb61-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb61-22"><a href="#cb61-22" aria-hidden="true" tabindex="-1"></a>        ) </span></code></pre></div>
<p><img src="montes_files/figure-html/unnamed-chunk-35-2.png" width="960" /></p>
<div class="sourceCode" id="cb62"><pre
class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="do">### Barplot for power</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(sums, <span class="fu">aes</span>(<span class="at">y =</span> power, <span class="at">x =</span> <span class="fu">factor</span>(model), <span class="at">fill =</span> <span class="fu">factor</span>(n))) <span class="sc">+</span>  </span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">position=</span><span class="st">&quot;dodge&quot;</span>, <span class="at">alpha =</span> .<span class="dv">6</span>) <span class="sc">+</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_d</span>(<span class="at">begin =</span> .<span class="dv">2</span>, </span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">end =</span> .<span class="dv">8</span>, </span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>                       <span class="at">name =</span> <span class="st">&quot;Sample Size&quot;</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>                       ) <span class="sc">+</span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(success),</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>             <span class="at">labeller =</span> <span class="fu">label_bquote</span>(<span class="st">&quot;Prop. Success&quot;</span> <span class="sc">==</span> .(success))) <span class="sc">+</span></span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;Model&quot;</span>,</span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&quot;Power&quot;</span>,</span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&quot;PML Logit Models Retain Power Despite Downward Bias&quot;</span></span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face=</span><span class="st">&quot;bold&quot;</span>, <span class="at">size =</span> <span class="dv">17</span>),</span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid.major.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid.minor.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">13</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>),</span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title=</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">15</span>,<span class="at">face=</span><span class="st">&quot;bold&quot;</span>),</span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb62-22"><a href="#cb62-22" aria-hidden="true" tabindex="-1"></a>        ) </span></code></pre></div>
<p><img src="montes_files/figure-html/unnamed-chunk-35-3.png" width="960" /></p>
</div>
<div class="footnotes footnotes-end-of-document">
<hr />
<ol>
<li id="fn1"><p>This is in fact the <em>biased</em> sample variance.
Despite being biased, it is still weakly consistent/convergent. So as
not to confuse readers, I did not delve into the biased sample variance,
as it does not admit a simple “sample mean” formulation (i.e., 1/n…)
without some manipulation. Note however that the unbiased sample
variance also does converge in probability to the true mean, i.e., it is
consistent.<a href="#fnref1" class="footnote-back">↩︎</a></p></li>
<li id="fn2"><p>Here I use a kernel-based estimator of the density
function to highlight its interpretation as a sample mean. However,
other estimators exist which are consistent for the population density
function.<a href="#fnref2" class="footnote-back">↩︎</a></p></li>
<li id="fn3"><p>This is a simplistic sample estimator of the quantile
function, used here primarily for presentation purposes. In reality,
other estimators exist that are superior, and are still weakly
consistent/convergent.<a href="#fnref3"
class="footnote-back">↩︎</a></p></li>
<li id="fn4"><p>I’m aware that multi-threading and parallelism are not
the same thing. To keep things simple I treat them as the same here, as
their difference is not relevant for explaining the issue here.<a
href="#fnref4" class="footnote-back">↩︎</a></p></li>
</ol>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeCodeFolding("show" === "show");
});
</script>

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
